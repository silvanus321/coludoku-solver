<!DOCTYPE html>

<html lang="zh-TW">

<head>

Â Â Â Â <meta charset="UTF-8">

Â Â Â Â <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

Â Â Â Â <title>è‰²ç¨å°å°å¸« (2.0 åˆ†ç´šç‰ˆ)</title>

Â Â Â Â <style>

Â Â Â Â Â Â Â Â /* --- 1. åŸºç¤è¨­å®š --- */

Â Â Â Â Â Â Â Â body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #2c3e50; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; user-select: none; -webkit-user-select: none; touch-action: manipulation; color: white; min-height: 100vh; }

Â Â Â Â Â Â Â Â .header-box { position: relative; width: 100%; max-width: 400px; text-align: center; margin: 10px 0; }

Â Â Â Â Â Â Â Â h1 { margin: 0; letter-spacing: 2px; font-size: 1.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3); display: inline-block; }


Â Â Â Â Â Â Â Â /* --- 2. HUD & æ™‚é–“æ¢ --- */

Â Â Â Â Â Â Â Â .hud { display: grid; grid-template-columns: 1fr 1fr 1fr; width: 100%; max-width: 400px; background: rgba(255, 255, 255, 0.1); padding: 10px 15px; border-radius: 50px; margin-bottom: 5px; box-sizing: border-box; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); align-items: center; text-align: center; }

Â Â Â Â Â Â Â Â .hud-item { font-weight: bold; font-size: 0.85rem; }

Â Â Â Â Â Â Â Â .hud-val { color: #f1c40f; display: block; font-family: monospace; font-size: 1.2rem; }

Â Â Â Â Â Â Â Â .hud-val.urgent { color: #e74c3c; animation: blink 1s infinite; }

Â Â Â Â Â Â Â Â @keyframes blink { 50% { opacity: 0.5; } }


Â Â Â Â Â Â Â Â .time-bar-container { width: 100%; max-width: 380px; height: 10px; background: rgba(0,0,0,0.4); border-radius: 5px; margin-bottom: 15px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1); }

Â Â Â Â Â Â Â Â .time-bar-fill { height: 100%; width: 100%; background-color: #3498db; transition: width 1s linear, background-color 0.3s ease; box-shadow: 0 0 10px rgba(255,255,255,0.3); }

Â Â Â Â Â Â Â Â .time-bar-fill.state-purple { background-color: #9b59b6; box-shadow: 0 0 15px #8e44ad, 0 0 5px #fff; animation: electric 0.2s infinite alternate; }

Â Â Â Â Â Â Â Â .time-bar-fill.state-blue { background-color: #3498db; box-shadow: 0 0 5px #2980b9; }

Â Â Â Â Â Â Â Â .time-bar-fill.state-red { background-color: #c0392b; box-shadow: 0 0 15px #e74c3c; animation: shakeBar 0.5s infinite; }

Â Â Â Â Â Â Â Â @keyframes electric { 0% { opacity: 1; box-shadow: 0 0 15px #8e44ad; } 100% { opacity: 0.8; box-shadow: 0 0 25px #d2b4de; } }

Â Â Â Â Â Â Â Â @keyframes shakeBar { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-1px); opacity: 0.8; } 75% { transform: translateX(1px); opacity: 1; } }


Â Â Â Â Â Â Â Â .level-info { margin-top: 5px; font-size: 0.9rem; color: #f1c40f; min-height: 20px; font-weight: bold; text-align: center;}

Â Â Â Â Â Â Â Â .instruction-bar { font-size: 0.85rem; color: #bdc3c7; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 20px; margin-bottom: 10px; white-space: nowrap; text-align: center; }


Â Â Â Â Â Â Â Â /* --- 3. éŠæˆ²å€ --- */

Â Â Â Â Â Â Â Â .game-container { position: relative; width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; }

Â Â Â Â Â Â Â Â .main-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; background-color: #34495e; padding: 10px; border-radius: 12px; width: 100%; aspect-ratio: 1 / 1; box-sizing: border-box; position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

Â Â Â Â Â Â Â Â .main-grid.win-glow { box-shadow: 0 0 30px 10px rgba(241, 196, 15, 0.6); border: 2px solid #f1c40f; animation: pulse 1.5s infinite; }

Â Â Â Â Â Â Â Â @keyframes pulse { 0%, 100% { box-shadow: 0 0 15px 5px rgba(241, 196, 15, 0.4); } 50% { box-shadow: 0 0 30px 15px rgba(241, 196, 15, 0.8); } }


Â Â Â Â Â Â Â Â .block { background-color: #ecf0f1; border: 2px solid transparent; position: relative; border-radius: 6px; overflow: hidden; display: flex; justify-content: center; align-items: center; aspect-ratio: 1 / 1; }

Â Â Â Â Â Â Â Â .block.fixed { border-color: #c0392b; background-color: #fadbd8; }

Â Â Â Â Â Â Â Â .block.user-placed { border-color: #2980b9; }

Â Â Â Â Â Â Â Â .block-image { width: 100%; height: 100%; object-fit: contain; transition: transform 0.2s ease; }

Â Â Â Â Â Â Â Â .empty-slot { background-color: rgba(0,0,0,0.2); color: #7f8c8d; font-size: 2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; border: 2px dashed rgba(255,255,255,0.1); }

Â Â Â Â Â Â Â Â .zone-edge { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 11; }

Â Â Â Â Â Â Â Â .zone-center { position: absolute; top: 20%; left: 20%; width: 60%; height: 60%; z-index: 12; border-radius: 50%; }


Â Â Â Â Â Â Â Â /* å…‰æšˆå±¤ */

Â Â Â Â Â Â Â Â .glow-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; border-radius: 12px; overflow: hidden; }

Â Â Â Â Â Â Â Â .glow-bar { position: absolute; box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.5); border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 8px; transition: opacity 0.3s; }

Â Â Â Â Â Â Â Â .glow-row { left: 1%; width: 98%; height: 31%; background: linear-gradient(to bottom, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0) 25%, rgba(255,255,255,0) 75%, rgba(255,255,255,0.5) 100%); }

Â Â Â Â Â Â Â Â .glow-col { top: 1%; height: 98%; width: 31%; background: linear-gradient(to right, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0) 25%, rgba(255,255,255,0) 75%, rgba(255,255,255,0.5) 100%); }


Â Â Â Â Â Â Â Â /* --- 4. é¸å–®èˆ‡æŒ‰éˆ• --- */

Â Â Â Â Â Â Â Â .action-btn { background-color: #27ae60; color: white; border: none; padding: 15px 40px; font-size: 1.1rem; border-radius: 50px; cursor: pointer; margin-top: 25px; width: 80%; transition: all 0.2s; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

Â Â Â Â Â Â Â Â .action-btn:active { transform: scale(0.95); }

Â Â Â Â Â Â Â Â .button-group { display: flex; justify-content: space-between; width: 100%; margin-top: 20px; gap: 15px; }

Â Â Â Â Â Â Â Â .action-btn.btn-reset { background-color: #16a085; font-size: 1rem; padding: 10px; flex: 1; margin-top: 0; }

Â Â Â Â Â Â Â Â .action-btn.btn-reset:hover { background-color: #1abc9c; }

Â Â Â Â Â Â Â Â .action-btn.give-up { background-color: #7f8c8d; font-size: 1rem; padding: 10px; flex: 1; margin-top: 0; }

Â Â Â Â Â Â Â Â .action-btn.give-up:hover { background-color: #95a5a6; }

Â Â Â Â Â Â Â Â .action-btn.failed { background-color: #c0392b; cursor: not-allowed; }


Â Â Â Â Â Â Â Â /* ç­‰ç´šé¸æ“‡éˆ• */

Â Â Â Â Â Â Â Â .lvl-btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 300px; margin: 20px auto; }

Â Â Â Â Â Â Â Â .lvl-btn { background: #34495e; border: 2px solid #bdc3c7; color: #ecf0f1; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 1rem;}

Â Â Â Â Â Â Â Â .lvl-btn small { font-size: 0.75rem; color: #95a5a6; display: block; margin-top: 4px; font-weight: normal;}

Â Â Â Â Â Â Â Â .lvl-btn.active { background: #f1c40f; border-color: #f39c12; color: #2c3e50; box-shadow: 0 0 15px rgba(241, 196, 15, 0.5); }

Â Â Â Â Â Â Â Â .lvl-btn.active small { color: #555; }

Â Â Â Â Â Â Â Â .name-input { padding: 15px; border-radius: 10px; border: none; font-size: 1.2rem; width: 70%; text-align: center; margin-bottom: 20px; background: rgba(255,255,255,0.9); }


Â Â Â Â Â Â Â Â /* --- 5. å½ˆçª—èˆ‡çµç®— --- */

Â Â Â Â Â Â Â Â .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); overflow-y: auto; }

Â Â Â Â Â Â Â Â .modal-content { background: white; color: #333; padding: 25px; border-radius: 15px; width: 95%; max-width: 500px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-height: 95vh; overflow-y: auto; }

Â Â Â Â Â Â Â Â 

Â Â Â Â Â Â Â Â .picker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }

Â Â Â Â Â Â Â Â .picker-item { border: 1px solid #ddd; border-radius: 8px; padding: 5px; cursor: pointer; }

Â Â Â Â Â Â Â Â .picker-item img { width: 100%; }


Â Â Â Â Â Â Â Â .percentile-box { background: #e74c3c; color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; margin: 8px auto 0; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}

Â Â Â Â Â Â Â Â 

Â Â Â Â Â Â Â Â /* æ’è¡Œæ¦œ */

Â Â Â Â Â Â Â Â .level-boards-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; width: 100%;}

Â Â Â Â Â Â Â Â .level-board { background: #fff; border: 2px solid #ecf0f1; border-radius: 10px; padding: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);}

Â Â Â Â Â Â Â Â .level-board-title { font-weight: bold; color: #2980b9; text-align: center; margin-bottom: 5px; border-bottom: 2px solid #3498db; padding-bottom: 4px; font-size: 0.9rem;}

Â Â Â Â Â Â Â Â 

Â Â Â Â Â Â Â Â .lb-mini-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; text-align: left; }

Â Â Â Â Â Â Â Â .lb-mini-table td { padding: 5px 2px; border-bottom: 1px dashed #ecf0f1; vertical-align: middle; }

Â Â Â Â Â Â Â Â .lb-mini-table tr:last-child td { border-bottom: none; }

Â Â Â Â Â Â Â Â .lb-mini-table .rank { font-weight: bold; color: #f39c12; width: 15px; text-align: center;}

Â Â Â Â Â Â Â Â .lb-mini-table .name { font-weight: bold; color: #34495e; max-width: 75px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

Â Â Â Â Â Â Â Â .lb-mini-table .score-time { text-align: right; color: #7f8c8d; font-family: monospace; line-height: 1.2;}

Â Â Â Â Â Â Â Â .title-tag { color: #8e44ad; font-size: 0.7rem; font-weight: bold;}


Â Â Â Â Â Â Â Â #start-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: #2c3e50; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }

Â Â Â Â Â Â Â Â .intro-box { text-align: center; padding: 20px; width: 100%; box-sizing: border-box;}

Â Â Â Â Â Â Â Â .intro-title { font-size: 2.5rem; color: #f1c40f; margin-bottom: 10px; letter-spacing: 3px; }

Â Â Â Â Â Â Â Â .intro-desc { font-size: 1.1rem; color: #ecf0f1; margin-bottom: 20px; line-height: 1.8; }

Â Â Â Â </style>

</head>

<body>


Â Â Â Â <div id="start-screen">

Â Â Â Â Â Â Â Â <div class="intro-box">

Â Â Â Â Â Â Â Â Â Â Â Â <div class="intro-title">ğŸ”®è‰²ç¨å°å°å¸«ğŸ”®</div>

Â Â Â Â Â Â Â Â Â Â Â Â <div class="intro-desc"><strong>è¡Œåˆ—å¯¶çŸ³ç›¸ç•°ï¼Œå®Œæˆè‰²ç¨å°å°</strong></div>

Â Â Â Â Â Â Â Â Â Â Â Â <div class="lvl-btn-group">

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <button class="lvl-btn" onclick="selectLevel(1, this)">LEVEL 1<br><small>Shape 01-12</small></button>

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <button class="lvl-btn active" onclick="selectLevel(2, this)">LEVEL 2<br><small>Shape 13-24</small></button>

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <button class="lvl-btn" onclick="selectLevel(3, this)">LEVEL 3<br><small>Shape 25-36</small></button>

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <button class="lvl-btn" onclick="selectLevel(4, this)">LEVEL 4<br><small>Shape 37-48</small></button>

<button class="lvl-btn" onclick="selectLevel(5, this)">LEVEL 5<br><small>Shape 49-60</small></button>

<button class="lvl-btn" onclick="selectLevel(6, this)">LEVEL 6<br><small>Shape 61-72</small></button>

Â Â Â Â Â Â Â Â Â Â Â Â </div>

Â Â Â Â Â Â Â Â Â Â Â Â <input type="text" id="player-name" class="name-input" placeholder="è«‹è¼¸å…¥å°å°å¸«åè™Ÿ" maxlength="10">

Â Â Â Â Â Â Â Â Â Â Â Â <button class="action-btn" onclick="startGame()" style="margin-top: 0;">é–‹å§‹æŒ‘æˆ°</button>

Â Â Â Â Â Â Â Â </div>

Â Â Â Â </div>


Â Â Â Â <div class="header-box"><h1 id="game-title">Round 1</h1></div>

Â Â Â Â 

Â Â Â Â <div class="hud">

Â Â Â Â Â Â Â Â <div class="hud-item">é—œå¡ <span id="round-disp" class="hud-val">1/6</span></div>

Â Â Â Â Â Â Â Â <div class="hud-item">å€’æ•¸ <span id="timer-disp" class="hud-val">04:00</span></div>

Â Â Â Â Â Â Â Â <div class="hud-item">å¾—åˆ† <span id="score-disp" class="hud-val">0</span></div>

Â Â Â Â </div>


Â Â Â Â <div class="time-bar-container"><div id="time-bar-fill" class="time-bar-fill"></div></div>


Â Â Â Â <div class="game-container">

Â Â Â Â Â Â Â Â <div class="level-info" id="level-info"></div>

Â Â Â Â Â Â Â Â <div class="instruction-bar">ğŸ‘†è¼•é»ä¸­é–“ç¿»é¢ | ğŸ”„è¼•é»é‚Šç·£æ—‹è½‰ | ğŸ—‘ï¸é•·æŒ‰ä¸­é–“ç§»é™¤</div>

Â Â Â Â Â Â Â Â <div id="grid-container" class="main-grid"></div>

Â Â Â Â Â Â Â Â <button id="btn-next" class="action-btn" style="display:none;" onclick="nextLevel()">ä¸‹ä¸€é—œ â¡ï¸</button>

Â Â Â Â Â Â Â Â 

Â Â Â Â Â Â Â Â <div id="action-controls" class="button-group">

Â Â Â Â Â Â Â Â Â Â Â Â <button id="btn-reset" class="action-btn btn-reset" onclick="resetLevel()">ğŸ”„ é‡ç½®</button>

Â Â Â Â Â Â Â Â Â Â Â Â <button id="btn-solve" class="action-btn give-up" onclick="forceSolve(true)">ğŸ³ï¸ æ”¾æ£„</button>

Â Â Â Â Â Â Â Â </div>

Â Â Â Â </div>


Â Â Â Â <div id="picker-modal" class="modal-overlay" onclick="closePicker()">

Â Â Â Â Â Â Â Â <div class="modal-content" onclick="event.stopPropagation()">

Â Â Â Â Â Â Â Â Â Â Â Â <h3 id="picker-title">é¸æ“‡é­”çŸ³ (Bé¢)</h3>

Â Â Â Â Â Â Â Â Â Â Â Â <div id="picker-grid" class="picker-grid"></div>

Â Â Â Â Â Â Â Â Â Â Â Â <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <button onclick="togglePickerFace()" style="padding:10px 20px; background:#9b59b6; color:white; border:none; border-radius:20px; font-weight:bold;">ğŸ”„ ç¿»é¢</button>

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <button onclick="closePicker()" style="padding:10px 20px; background:#ddd; border:none; border-radius:20px;">å–æ¶ˆ</button>

Â Â Â Â Â Â Â Â Â Â Â Â </div>

Â Â Â Â Â Â Â Â </div>

Â Â Â Â </div>


Â Â Â Â <div id="end-modal" class="modal-overlay">

Â Â Â Â Â Â Â Â <div class="modal-content">

Â Â Â Â Â Â Â Â Â Â Â Â <div style="background:#f4f6f7; padding:15px 10px; border-radius:10px; margin-bottom:15px;">

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <div style="font-size:1.1rem; color:#2c3e50; font-weight:bold;" id="end-player-name"></div>

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <div style="display:flex; justify-content:center; gap:20px; margin-top:8px;">

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <div>å¾—åˆ† <span id="end-score" style="color:#27ae60; font-weight:bold; font-size:1.1rem;">0 / 100</span></div>

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <div>ç¸½è€—æ™‚ <span id="end-time" style="color:#e67e22; font-weight:bold; font-size:1.1rem;">00:00</span></div>

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <div class="percentile-box" id="end-percentile">ğŸ† æ“Šæ•—äº†å…¨æœ 100% çš„ç©å®¶</div>

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <div id="end-msg" style="margin-top:5px; font-size:0.9rem; color:#555;"></div>

Â Â Â Â Â Â Â Â Â Â Â Â </div>


Â Â Â Â Â Â Â Â Â Â Â Â <div class="level-boards-container" id="level-boards"></div>

Â Â Â Â Â Â Â Â Â Â Â Â <button class="action-btn" style="margin-top:20px; padding:10px 30px;" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>

Â Â Â Â Â Â Â Â </div>

Â Â Â Â </div>


Â Â Â Â <script>

Â Â Â Â Â Â Â Â // --- DOM ç°¡å¯«åŠ©æ‰‹ (å¤§å¹…ç˜¦èº«é—œéµ) ---

Â Â Â Â Â Â Â Â const $ = id => document.getElementById(id);


Â Â Â Â Â Â Â Â // --- 0. éŸ³æ•ˆç³»çµ± ---

Â Â Â Â Â Â Â Â const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

Â Â Â Â Â Â Â Â function playSound(type) {

Â Â Â Â Â Â Â Â Â Â Â Â if (audioCtx.state === 'suspended') audioCtx.resume();

Â Â Â Â Â Â Â Â Â Â Â Â const osc = audioCtx.createOscillator(), gainNode = audioCtx.createGain(), now = audioCtx.currentTime;

Â Â Â Â Â Â Â Â Â Â Â Â osc.connect(gainNode); gainNode.connect(audioCtx.destination);

Â Â Â Â Â Â Â Â Â Â Â Â if (type === 'action') {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â osc.start(now); osc.stop(now + 0.1);

Â Â Â Â Â Â Â Â Â Â Â Â } else if (type === 'line') {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â osc.type = 'triangle'; osc.frequency.setValueAtTime(1200, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.3);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â osc.start(now); osc.stop(now + 0.5);

Â Â Â Â Â Â Â Â Â Â Â Â } else if (type === 'win') {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â playNote(523.25, now, 0.1); playNote(659.25, now + 0.1, 0.1); playNote(783.99, now + 0.2, 0.4);Â 

Â Â Â Â Â Â Â Â Â Â Â Â } else if (type === 'bonus') {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â playNote(880, now, 0.1); playNote(1760, now + 0.1, 0.2);Â 

Â Â Â Â Â Â Â Â Â Â Â Â } else if (type === 'reset') {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(800, now + 0.2);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.3);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â osc.start(now); osc.stop(now + 0.3);

Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â function playNote(freq, time, dur) {

Â Â Â Â Â Â Â Â Â Â Â Â const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();

Â Â Â Â Â Â Â Â Â Â Â Â osc.connect(gain); gain.connect(audioCtx.destination);

Â Â Â Â Â Â Â Â Â Â Â Â osc.type = 'square'; osc.frequency.value = freq;

Â Â Â Â Â Â Â Â Â Â Â Â gain.gain.setValueAtTime(0.1, time); gain.gain.exponentialRampToValueAtTime(0.01, time + dur);

Â Â Â Â Â Â Â Â Â Â Â Â osc.start(time); osc.stop(time + dur);

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â // --- 1. è³‡æ–™åº« (ä¿®æ­£äº†æœ€å¾Œä¸€è¡Œå¤šé¤˜çš„å³æ‹¬è™Ÿ) ---

Â Â Â Â Â Â Â Â const BLOCKS={1:{B:[[1,2],[3,4]],W:[[5,6],[3,4]]},2:{B:[[4,6],[3,5]],W:[[2,6],[1,5]]},3:{B:[[2,1],[6,5]],W:[[3,4],[1,2]]},4:{B:[[5,2],[6,3]],W:[[4,1],[5,2]]},5:{B:[[4,5],[1,2]],W:[[3,4],[6,1]]},6:{B:[[1,4],[6,3]],W:[[6,3],[5,2]]},7:{B:[[1,6],[5,4]],W:[[2,3],[6,1]]},8:{B:[[2,6],[3,1]],W:[[2,4],[3,5]]},9:{B:[[2,3],[4,5]],W:[[6,1],[4,5]]}};

Â Â Â Â Â Â Â Â const TARGET_TILES=[{id:1,blocks:[{id:1,f:'B'},{id:5,f:'B'},{id:9,f:'B'}]},{id:2,blocks:[{id:2,f:'B'},{id:6,f:'B'},{id:7,f:'B'}]},{id:3,blocks:[{id:3,f:'B'},{id:4,f:'B'},{id:8,f:'B'}]},{id:4,blocks:[{id:3,f:'B'},{id:5,f:'B'},{id:7,f:'B'}]},{id:5,blocks:[{id:1,f:'B'},{id:6,f:'B'},{id:8,f:'B'}]},{id:6,blocks:[{id:2,f:'B'},{id:4,f:'B'},{id:9,f:'B'}]},{id:7,blocks:[{id:1,f:'B'},{id:5,f:'B'},{id:8,f:'W'}]},{id:8,blocks:[{id:2,f:'B'},{id:9,f:'B'},{id:6,f:'W'}]},{id:9,blocks:[{id:6,f:'B'},{id:1,f:'W'},{id:7,f:'B'}]},{id:10,blocks:[{id:9,f:'W'},{id:3,f:'B'},{id:4,f:'W'}]},{id:11,blocks:[{id:2,f:'W'},{id:7,f:'W'},{id:4,f:'B'}]},{id:12,blocks:[{id:5,f:'W'},{id:3,f:'W'},{id:8,f:'B'}]},{id:13,blocks:[{id:5,f:'B'},{id:3,f:'B'},{id:9,f:'W'}]},{id:14,blocks:[{id:1,f:'B'},{id:5,f:'W'},{id:8,f:'B'}]},{id:15,blocks:[{id:4,f:'B'},{id:8,f:'B'},{id:2,f:'W'}]},{id:16,blocks:[{id:3,f:'B'},{id:6,f:'W'},{id:7,f:'W'}]},{id:17,blocks:[{id:9,f:'W'},{id:6,f:'B'},{id:1,f:'W'}]},{id:18,blocks:[{id:4,f:'W'},{id:2,f:'W'},{id:7,f:'B'}]},{id:19,blocks:[{id:3,f:'B'},{id:4,f:'B'},{id:7,f:'W'}]},{id:20,blocks:[{id:9,f:'B'},{id:4,f:'W'},{id:1,f:'B'}]},{id:21,blocks:[{id:7,f:'B'},{id:5,f:'B'},{id:2,f:'W'}]},{id:22,blocks:[{id:6,f:'W'},{id:8,f:'W'},{id:2,f:'B'}]},{id:23,blocks:[{id:5,f:'B'},{id:8,f:'W'},{id:3,f:'W'}]},{id:24,blocks:[{id:1,f:'W'},{id:9,f:'B'},{id:6,f:'W'}]},{id:25,blocks:[{id:2,f:'B'},{id:6,f:'B'},{id:9,f:'W'}]},{id:26,blocks:[{id:7,f:'B'},{id:4,f:'W'},{id:3,f:'B'}]},{id:27,blocks:[{id:9,f:'B'},{id:4,f:'B'},{id:1,f:'W'}]},{id:28,blocks:[{id:1,f:'B'},{id:8,f:'W'},{id:4,f:'W'}]},{id:29,blocks:[{id:9,f:'W'},{id:5,f:'B'},{id:2,f:'W'}]},{id:30,blocks:[{id:8,f:'B'},{id:6,f:'W'},{id:2,f:'W'}]},{id:31,blocks:[{id:1,f:'B'},{id:6,f:'B'},{id:7,f:'W'}]},{id:32,blocks:[{id:3,f:'B'},{id:8,f:'B'},{id:6,f:'W'}]},{id:33,blocks:[{id:5,f:'B'},{id:9,f:'B'},{id:3,f:'W'}]},{id:34,blocks:[{id:1,f:'B'},{id:5,f:'W'},{id:7,f:'W'}]},{id:35,blocks:[{id:8,f:'W'},{id:4,f:'B'},{id:1,f:'W'}]},{id:36,blocks:[{id:3,f:'W'},{id:4,f:'W'},{id:9,f:'B'}]},{id:37,blocks:[{id:4,f:'B'},{id:2,f:'B'},{id:8,f:'W'}]},{id:38,blocks:[{id:2,f:'B'},{id:5,f:'W'},{id:7,f:'B'}]},{id:39,blocks:[{id:8,f:'B'},{id:6,f:'B'},{id:3,f:'W'}]},{id:40,blocks:[{id:5,f:'W'},{id:2,f:'B'},{id:9,f:'W'}]},{id:41,blocks:[{id:3,f:'W'},{id:7,f:'W'},{id:6,f:'B'}]},{id:42,blocks:[{id:7,f:'B'},{id:5,f:'W'},{id:1,f:'W'}]},{id:43,blocks:[{id:1,f:'W'},{id:5,f:'W'},{id:9,f:'W'}]},{id:44,blocks:[{id:2,f:'W'},{id:6,f:'W'},{id:7,f:'W'}]},{id:45,blocks:[{id:3,f:'W'},{id:4,f:'W'},{id:8,f:'W'}]},{id:46,blocks:[{id:3,f:'W'},{id:5,f:'W'},{id:7,f:'W'}]},{id:47,blocks:[{id:1,f:'W'},{id:6,f:'W'},{id:8,f:'W'}]},{id:48,blocks:[{id:2,f:'W'},{id:4,f:'W'},{id:9,f:'W'}]}];

Â Â Â Â Â Â Â Â const SHAPES=[{id:1,name:"No.001",active:[2,3,4,9],targets:[2,4,9]},{id:2,name:"No.002",active:[2,4,6,7],targets:[2,6,7]},{id:3,name:"No.003",active:[1,3,5,9],targets:[1,5,9]},{id:4,name:"No.004",active:[1,3,4,8],targets:[3,4,8]},{id:5,name:"No.005",active:[1,2,6,8],targets:[1,6,8]},{id:6,name:"No.006",active:[1,3,5,7],targets:[3,5,7]},{id:7,name:"No.007",active:[2,4,7,9],targets:[2,4,9]},{id:8,name:"No.008",active:[2,6,7,8],targets:[2,6,7]},{id:9,name:"No.009",active:[1,5,8,9],targets:[1,5,9]},{id:10,name:"No.010",active:[3,4,8,9],targets:[3,4,8]},{id:11,name:"No.011",active:[1,4,6,8],targets:[1,6,8]},{id:12,name:"No.012",active:[3,5,7,8],targets:[3,5,7]},{id:13,name:"No.013",active:[2,3,4,7,9],targets:[2,4,9]},{id:14,name:"No.014",active:[2,4,6,7,8],targets:[2,6,7]},{id:15,name:"No.015",active:[1,3,5,8,9],targets:[1,5,9]},{id:16,name:"No.016",active:[1,3,4,8,9],targets:[3,4,8]},{id:17,name:"No.017",active:[1,2,4,6,8],targets:[1,6,8]},{id:18,name:"No.018",active:[1,3,5,7,8],targets:[3,5,7]},{id:19,name:"No.019",active:[2,4,5,8,9],targets:[2,4,9]},{id:20,name:"No.020",active:[2,6,7,8,9],targets:[2,6,7]},{id:21,name:"No.021",active:[1,2,5,8,9],targets:[1,5,9]},{id:22,name:"No.022",active:[2,3,4,5,8],targets:[3,4,8]},{id:23,name:"No.023",active:[1,2,3,6,8],targets:[1,6,8]},{id:24,name:"No.024",active:[2,3,5,7,8],targets:[3,5,7]},{id:25,name:"No.025",active:[2,4,6,7,8,9],targets:[2,4,9]},{id:26,name:"No.026",active:[2,4,5,6,7,9],targets:[2,6,7]},{id:27,name:"No.027",active:[1,3,5,7,8,9],targets:[1,5,9]},{id:28,name:"No.028",active:[2,3,4,6,8,9],targets:[3,4,8]},{id:29,name:"No.029",active:[1,2,5,6,7,8],targets:[1,6,8]},{id:30,name:"No.030",active:[1,3,5,6,7,9],targets:[3,5,7]},{id:31,name:"No.031",active:[2,4,5,6,8,9],targets:[2,4,9]},{id:32,name:"No.032",active:[2,5,6,7,8,9],targets:[2,6,7]},{id:33,name:"No.033",active:[1,2,3,5,6,9],targets:[1,5,9]},{id:34,name:"No.034",active:[2,3,4,5,6,8],targets:[3,4,8]},{id:35,name:"No.035",active:[1,2,3,5,6,8],targets:[1,6,8]},{id:36,name:"No.036",active:[1,2,3,4,5,7],targets:[3,5,7]},{id:37,name:"No.037",active:[1,2,4,5,6,8,9],targets:[2,4,9]},{id:38,name:"No.038",active:[1,2,4,6,7,8,9],targets:[2,6,7]},{id:39,name:"No.039",active:[1,3,5,6,7,8,9],targets:[1,5,9]},{id:40,name:"No.040",active:[2,3,4,5,6,7,8],targets:[3,4,8]},{id:41,name:"No.041",active:[1,2,3,4,6,8,9],targets:[1,6,8]},{id:42,name:"No.042",active:[1,3,4,5,7,8,9],targets:[3,5,7]},{id:43,name:"No.043",active:[1,2,3,4,6,7,9],targets:[2,4,9]},{id:44,name:"No.044",active:[2,4,5,6,7,8,9],targets:[2,6,7]},{id:45,name:"No.045",active:[1,3,4,5,6,7,9],targets:[1,5,9]},{id:46,name:"No.046",active:[1,2,3,4,7,8,9],targets:[3,4,8]},{id:47,name:"No.047",active:[1,2,4,5,6,7,8],targets:[1,6,8]},{id:48,name:"No.048",active:[1,2,3,5,7,8,9],targets:[3,5,7]},{id:49,name:"No.049",active:[2,3,4,5,6,7,8,9],targets:[2,4,9]},{id:50,name:"No.050",active:[1,2,3,4,6,7,8,9],targets:[2,6,7]},{id:51,name:"No.051",active:[1,3,4,5,6,7,8,9],targets:[1,5,9]},{id:52,name:"No.052",active:[1,2,3,4,5,6,8,9],targets:[3,4,8]},{id:53,name:"No.053",active:[1,2,3,4,6,7,8,9],targets:[1,6,8]},{id:54,name:"No.054",active:[1,2,3,5,6,7,8,9],targets:[3,5,7]},{id:55,name:"No.055",active:[1,2,3,5,6,7,8,9],targets:[2,4,9]},{id:56,name:"No.056",active:[2,4,5,6,7,8,9],targets:[2,6,7]},{id:57,name:"No.057",active:[1,3,4,5,6,7,9],targets:[1,5,9]},{id:58,name:"No.058",active:[1,2,3,4,7,8,9],targets:[3,4,8]},{id:59,name:"No.059",active:[1,2,4,5,6,7,8],targets:[1,6,8]},{id:60,name:"No.060",active:[1,2,3,5,7,8,9],targets:[3,5,7]},{id:61,name:"No.061",active:[1,2,3,4,5,6,7,8,9],targets:[2,4,9]},{id:62,name:"No.062",active:[1,2,3,4,5,6,7,8,9],targets:[2,6,7]},{id:63,name:"No.063",active:[1,2,3,4,5,6,7,8,9],targets:[1,5,9]},{id:64,name:"No.064",active:[1,2,3,4,5,6,7,8,9],targets:[3,4,8]},{id:65,name:"No.065",active:[1,2,3,4,5,6,7,8,9],targets:[1,6,8]},{id:66,name:"No.066",active:[1,2,3,4,5,6,7,8,9],targets:[3,5,7]},{id:67,name:"No.067",active:[1,2,3,4,5,6,7,8,9],targets:[2,4,9]},{id:68,name:"No.068",active:[1,2,3,4,5,6,7,8,9],targets:[2,6,7]},{id:69,name:"No.069",active:[1,2,3,4,5,6,7,8,9],targets:[1,5,9]},{id:70,name:"No.070",active:[1,2,3,4,5,6,7,8,9],targets:[3,4,8]},{id:71,name:"No.071",active:[1,2,3,4,5,6,7,8,9],targets:[1,6,8]},{id:72,name:"No.072",active:[1,2,3,4,5,6,7,8,9],targets:[3,5,7]}];

Â Â Â Â Â Â Â Â const ROUND_SETTINGS={1:{time:240,base:12,bonus:1},2:{time:210,base:12,bonus:2},3:{time:180,base:13,bonus:3},4:{time:150,base:13,bonus:4},5:{time:120,base:14,bonus:5},6:{time:90,base:14,bonus:6}};


Â Â Â Â Â Â Â Â // --- è®Šæ•¸ ---

Â Â Â Â Â Â Â Â let playerName = "", selectedLevel = 1, roundPool = [], currentRound = 1;

Â Â Â Â Â Â Â Â let totalScore = 0, totalTimeSpent = 0, roundStartTime = 0;Â 

Â Â Â Â Â Â Â Â let currentLayoutConfig = {}, userBoard = Array(9).fill(null);

Â Â Â Â Â Â Â Â let pickingSlot = -1, isRoundWon = false, isSolverUsed = false;

Â Â Â Â Â Â Â Â let timerInterval, timeLeft = 0, currentTotalTime = 0, lastValidLineCount = 0;

Â Â Â Â Â Â Â Â let longPressTimer, pickerFace = 'B';Â 


Â Â Â Â Â Â Â Â // --- æ ¸å¿ƒæµç¨‹ ---

Â Â Â Â Â Â Â Â function selectLevel(lvl, btn) {

Â Â Â Â Â Â Â Â Â Â Â Â selectedLevel = lvl;

Â Â Â Â Â Â Â Â Â Â Â Â document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('active'));

Â Â Â Â Â Â Â Â Â Â Â Â btn.classList.add('active'); playSound('action');

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function getShapesByLevel(lvl) {

Â Â Â Â Â Â Â Â Â Â Â Â let pool = SHAPES.filter(s => {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (lvl===1) return s.id>=1 && s.id<=12;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (lvl===2) return s.id>=13 && s.id<=24;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (lvl===3) return s.id>=25 && s.id<=36;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (lvl===4) return s.id>=37 && s.id<=48;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (lvl===5) return s.id>=49 && s.id<=60;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return s.id>=61 && s.id<=72;

Â Â Â Â Â Â Â Â Â Â Â Â });

Â Â Â Â Â Â Â Â Â Â Â Â return pool.sort(() => Math.random() - 0.5).slice(0, 6);

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function startGame() {

Â Â Â Â Â Â Â Â Â Â Â Â const nameInput = $('player-name').value.trim();

Â Â Â Â Â Â Â Â Â Â Â Â if (!nameInput) return alert("è«‹è¼¸å…¥å°å°å¸«åè™Ÿï¼");

Â Â Â Â Â Â Â Â Â Â Â Â if (audioCtx.state === 'suspended') audioCtx.resume();

Â Â Â Â Â Â Â Â Â Â Â Â 

Â Â Â Â Â Â Â Â Â Â Â Â playerName = nameInput; $('start-screen').style.display = 'none';

Â Â Â Â Â Â Â Â Â Â Â Â currentRound = 1; totalScore = 0; totalTimeSpent = 0;

Â Â Â Â Â Â Â Â Â Â Â Â roundPool = getShapesByLevel(selectedLevel);

Â Â Â Â Â Â Â Â Â Â Â Â updateHUD(); loadRound(currentRound);

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function loadRound(round) {

Â Â Â Â Â Â Â Â Â Â Â Â isRoundWon = false; isSolverUsed = false; lastValidLineCount = 0;

Â Â Â Â Â Â Â Â Â Â Â Â $('game-title').innerText = `Round ${round}`;

Â Â Â Â Â Â Â Â Â Â Â Â $('btn-next').style.display = 'none';

Â Â Â Â Â Â Â Â Â Â Â Â $('action-controls').style.display = 'flex';

Â Â Â Â Â Â Â Â Â Â Â Â 

Â Â Â Â Â Â Â Â Â Â Â Â let btnSolve = $('btn-solve'), btnReset = $('btn-reset');

Â Â Â Â Â Â Â Â Â Â Â Â btnSolve.style.display = 'block'; btnSolve.disabled = false;

Â Â Â Â Â Â Â Â Â Â Â Â btnSolve.innerText = "ğŸ³ï¸ æ”¾æ£„"; btnSolve.className = "action-btn give-up";

Â Â Â Â Â Â Â Â Â Â Â Â btnReset.style.display = 'block'; btnReset.disabled = false;

Â Â Â Â Â Â Â Â Â Â Â Â 

Â Â Â Â Â Â Â Â Â Â Â Â $('grid-container').classList.remove('win-glow');

Â Â Â Â Â Â Â Â Â Â Â Â $('timer-disp').classList.remove('urgent');


Â Â Â Â Â Â Â Â Â Â Â Â const config = ROUND_SETTINGS[round];

Â Â Â Â Â Â Â Â Â Â Â Â startTimer(config.time); roundStartTime = Date.now();


Â Â Â Â Â Â Â Â Â Â Â Â let solvable = false, attempts = 0, selectedShape = roundPool[round - 1], selectedTile;

Â Â Â Â Â Â Â Â Â Â Â Â while (!solvable && attempts < 50) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â selectedTile = TARGET_TILES[Math.floor(Math.random() * TARGET_TILES.length)];

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â currentLayoutConfig = {};

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â for(let i=0; i<9; i++) currentLayoutConfig[i] = { type: 'EMPTY' };

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â selectedShape.active.forEach(pos => { currentLayoutConfig[pos-1] = { type: 'SOLVE' }; });

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â selectedShape.targets.forEach((pos, idx) => {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (idx < selectedTile.blocks.length) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const b = selectedTile.blocks[idx];

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â currentLayoutConfig[pos-1] = { type: 'FIXED', id: b.id, face: b.f };

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } else { currentLayoutConfig[pos-1] = { type: 'SOLVE' }; }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â });

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (checkSolvability()) solvable = true;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â attempts++;

Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (!solvable) return alert("ç”Ÿæˆå¤±æ•—");


Â Â Â Â Â Â Â Â Â Â Â Â let levelInfo = $('level-info');

Â Â Â Â Â Â Â Â Â Â Â Â levelInfo.innerText = `${selectedShape.name} (é€šé—œ+${config.base}åˆ† | é€Ÿé€š+${config.bonus}åˆ†)`;

Â Â Â Â Â Â Â Â Â Â Â Â levelInfo.style.color = "#f1c40f";Â 

Â Â Â Â Â Â Â Â Â Â Â Â 

Â Â Â Â Â Â Â Â Â Â Â Â userBoard = Array(9).fill(null);

Â Â Â Â Â Â Â Â Â Â Â Â for(let i=0; i<9; i++) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (currentLayoutConfig[i].type === 'FIXED') {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â userBoard[i] = { id: currentLayoutConfig[i].id, face: currentLayoutConfig[i].face, rot: 0, isFixed: true };

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â renderGameGrid();

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function startTimer(seconds) {

Â Â Â Â Â Â Â Â Â Â Â Â clearInterval(timerInterval);

Â Â Â Â Â Â Â Â Â Â Â Â timeLeft = currentTotalTime = seconds;Â 

Â Â Â Â Â Â Â Â Â Â Â Â updateTimerDisplay(); updateTimeBar();Â 

Â Â Â Â Â Â Â Â Â Â Â Â timerInterval = setInterval(() => {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â timeLeft--; updateTimerDisplay(); updateTimeBar();

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (timeLeft <= 10) $('timer-disp').classList.add('urgent');

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (timeLeft <= 0) { clearInterval(timerInterval); handleTimeOut(); }

Â Â Â Â Â Â Â Â Â Â Â Â }, 1000);

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function updateTimerDisplay() {

Â Â Â Â Â Â Â Â Â Â Â Â const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');

Â Â Â Â Â Â Â Â Â Â Â Â const s = (timeLeft % 60).toString().padStart(2, '0');

Â Â Â Â Â Â Â Â Â Â Â Â $('timer-disp').innerText = `${m}:${s}`;

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function updateTimeBar() {

Â Â Â Â Â Â Â Â Â Â Â Â const bar = $('time-bar-fill'), pct = (timeLeft / currentTotalTime) * 100;

Â Â Â Â Â Â Â Â Â Â Â Â bar.style.width = `${pct}%`;

Â Â Â Â Â Â Â Â Â Â Â Â bar.classList.remove('state-purple', 'state-blue', 'state-red');

Â Â Â Â Â Â Â Â Â Â Â Â bar.classList.add(pct > 70 ? 'state-purple' : pct < 30 ? 'state-red' : 'state-blue');

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function handleTimeOut() {

Â Â Â Â Â Â Â Â Â Â Â Â if (isRoundWon) return;

Â Â Â Â Â Â Â Â Â Â Â Â calculateTimeSpent(); forceSolve(false);

Â Â Â Â Â Â Â Â Â Â Â Â let btnSolve = $('btn-solve'), levelInfo = $('level-info');

Â Â Â Â Â Â Â Â Â Â Â Â btnSolve.innerText = "âŒ› æŒ‘æˆ°å¤±æ•—"; btnSolve.className = "action-btn failed";

Â Â Â Â Â Â Â Â Â Â Â Â $('btn-reset').style.display = 'none';Â 

Â Â Â Â Â Â Â Â Â Â Â Â levelInfo.innerText = "æ™‚é–“è€—ç›¡ï¼Œæœ¬é—œä¸è¨ˆåˆ†"; levelInfo.style.color = "#e74c3c";

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function checkSolvability() {

Â Â Â Â Â Â Â Â Â Â Â Â let solverBoard = Array(9).fill(null), usedIDs = new Set();

Â Â Â Â Â Â Â Â Â Â Â Â for(let i=0; i<9; i++) if (currentLayoutConfig[i].type === 'FIXED') usedIDs.add(currentLayoutConfig[i].id);

Â Â Â Â Â Â Â Â Â Â Â Â return solveStep(0, solverBoard, usedIDs, true);

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function calculateTimeSpent() {

Â Â Â Â Â Â Â Â Â Â Â Â let spent = Math.floor((Date.now() - roundStartTime) / 1000);

Â Â Â Â Â Â Â Â Â Â Â Â return totalTimeSpent += spent, spent;

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function nextLevel() {

Â Â Â Â Â Â Â Â Â Â Â Â clearInterval(timerInterval);

Â Â Â Â Â Â Â Â Â Â Â Â const spent = calculateTimeSpent();Â 

Â Â Â Â Â Â Â Â Â Â Â Â if (!isSolverUsed) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const config = ROUND_SETTINGS[currentRound];

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â totalScore += config.base + (spent <= 60 ? config.bonus : 0);

Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â updateHUD(); currentRound++;

Â Â Â Â Â Â Â Â Â Â Â Â if (currentRound > 6) showEndScreen(); else loadRound(currentRound);

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function updateHUD() {

Â Â Â Â Â Â Â Â Â Â Â Â $('round-disp').innerText = `${currentRound} / 6`;

Â Â Â Â Â Â Â Â Â Â Â Â $('score-disp').innerText = totalScore;

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function resetLevel() {

Â Â Â Â Â Â Â Â Â Â Â Â if (isRoundWon || isSolverUsed) return;

Â Â Â Â Â Â Â Â Â Â Â Â playSound('reset');

Â Â Â Â Â Â Â Â Â Â Â Â for (let i = 0; i < 9; i++) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (currentLayoutConfig[i].type === 'FIXED') {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â userBoard[i].rot = 0; userBoard[i].face = currentLayoutConfig[i].face;Â 

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } else { userBoard[i] = null; }

Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â renderGameGrid(); lastValidLineCount = 0;

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â // --- æ’è¡Œæ¦œ ---

Â Â Â Â Â Â Â Â function saveRecord(now) {

Â Â Â Â Â Â Â Â Â Â Â Â const record = { name: playerName, score: totalScore, time: totalTimeSpent, lvl: selectedLevel, date: now };

Â Â Â Â Â Â Â Â Â Â Â Â let lb = JSON.parse(localStorage.getItem('coludoku_lb_v4') || "[]");

Â Â Â Â Â Â Â Â Â Â Â Â lb.push(record);

Â Â Â Â Â Â Â Â Â Â Â Â lb.sort((a,b) => b.score - a.score || a.time - b.time);

Â Â Â Â Â Â Â Â Â Â Â Â if (lb.length > 500) lb = lb.slice(0, 500);

Â Â Â Â Â Â Â Â Â Â Â Â localStorage.setItem('coludoku_lb_v4', JSON.stringify(lb));

Â Â Â Â Â Â Â Â Â Â Â Â return lb;

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function getRankTitle(score) {

Â Â Â Â Â Â Â Â Â Â Â Â let maxS = 0; for(let i=1; i<=6; i++) maxS += (ROUND_SETTINGS[i].base + ROUND_SETTINGS[i].bonus);

Â Â Â Â Â Â Â Â Â Â Â Â let pct = score / maxS;

Â Â Â Â Â Â Â Â Â Â Â Â return pct===1 ? "å‚³å¥‡" : pct>=0.9 ? "è‡³å°Š" : pct>=0.75 ? "é«˜ç´š" : pct>=0.6 ? "åˆç´š" : "è¦‹ç¿’";

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function formatTime(sec) {

Â Â Â Â Â Â Â Â Â Â Â Â const m = Math.floor(sec / 60).toString().padStart(2,'0'), s = (sec % 60).toString().padStart(2,'0');

Â Â Â Â Â Â Â Â Â Â Â Â return `${m}:${s}`;

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function showEndScreen() {

Â Â Â Â Â Â Â Â Â Â Â Â $('end-modal').style.display = 'flex';

Â Â Â Â Â Â Â Â Â Â Â Â let maxScore = 0; for(let i=1; i<=6; i++) maxScore += (ROUND_SETTINGS[i].base + ROUND_SETTINGS[i].bonus);


Â Â Â Â Â Â Â Â Â Â Â Â $('end-player-name').innerText = `[${getRankTitle(totalScore)}] ${playerName} (æŒ‘æˆ° L${selectedLevel})`;

Â Â Â Â Â Â Â Â Â Â Â Â $('end-score').innerText = `${totalScore} / ${maxScore}`;

Â Â Â Â Â Â Â Â Â Â Â Â $('end-time').innerText = formatTime(totalTimeSpent);

Â Â Â Â Â Â Â Â Â Â Â Â 

Â Â Â Â Â Â Â Â Â Â Â Â let pct = totalScore / maxScore;

Â Â Â Â Â Â Â Â Â Â Â Â $('end-msg').innerText = pct===1 ? "è¶…å‡¡å…¥è–ï¼Œå‚³å¥‡å°å°å¸«ï¼ğŸ†" : pct>=0.9 ? "å‡ºé¡æ‹”èƒï¼Œè‡³å°Šå°å°å¸«ï¼âœ¨" : pct>=0.75 ? "é¦–å±ˆä¸€æŒ‡ï¼Œé«˜ç´šå°å°å¸«ï¼" : pct>=0.6 ? "ä¸­è¦ä¸­çŸ©ï¼Œåˆç´šå°å°å¸«ï¼" : "å†æ¥å†å‹µ...è¦‹ç¿’å°å°å¸«ï¼";


Â Â Â Â Â Â Â Â Â Â Â Â const now = Date.now(), lbData = saveRecord(now);

Â Â Â Â Â Â Â Â Â Â Â Â const myRankIndex = lbData.findIndex(r => r.date === now), totalPlayers = lbData.length;

Â Â Â Â Â Â Â Â Â Â Â Â let beatenPct = totalPlayers > 1 ? Math.floor(((totalPlayers - myRankIndex - 1) / totalPlayers) * 100) : 100;

Â Â Â Â Â Â Â Â Â Â Â Â if (totalPlayers > 1 && myRankIndex === 0) beatenPct = 99;

Â Â Â Â Â Â Â Â Â Â Â Â $('end-percentile').innerText = `ğŸ† æ“Šæ•—äº†å…¨æœ ${beatenPct}% çš„ç©å®¶`;


Â Â Â Â Â Â Â Â Â Â Â Â const container = $('level-boards');

Â Â Â Â Â Â Â Â Â Â Â Â container.innerHTML = "";

Â Â Â Â Â Â Â Â Â Â Â Â for (let i = 0; i <= 3; i++) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â let lvlData = lbData.filter(r => r.lvl === i).slice(0, 5);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â let boardHtml = `<div class="level-board"><div class="level-board-title">LEVEL ${i} æ’è¡Œæ¦œ</div><table class="lb-mini-table">`;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (lvlData.length === 0) boardHtml += `<tr><td style="text-align:center; color:#999; padding:15px 0;">å°šç„¡ç´€éŒ„</td></tr>`;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â else lvlData.forEach((r, idx) => { boardHtml += `<tr><td class="rank">${idx + 1}</td><td class="name"><span class="title-tag">[${getRankTitle(r.score)}]</span> ${r.name}</td><td class="score-time">${r.score}åˆ† ${formatTime(r.time)}</td></tr>`; });

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â boardHtml += `</table></div>`; container.innerHTML += boardHtml;

Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â // --- éŠæˆ²æ“ä½œ ---

Â Â Â Â Â Â Â Â function renderGameGrid() {

Â Â Â Â Â Â Â Â Â Â Â Â const container = $('grid-container');

Â Â Â Â Â Â Â Â Â Â Â Â container.innerHTML = '';

Â Â Â Â Â Â Â Â Â Â Â Â const glowLayer = document.createElement('div');

Â Â Â Â Â Â Â Â Â Â Â Â glowLayer.className = 'glow-overlay'; glowLayer.id = 'glow-layer';

Â Â Â Â Â Â Â Â Â Â Â Â container.appendChild(glowLayer);


Â Â Â Â Â Â Â Â Â Â Â Â for(let i=0; i<9; i++) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const config = currentLayoutConfig[i], block = userBoard[i], div = document.createElement('div');

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (config.type === 'EMPTY') {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â div.className = 'block empty-slot'; div.style.visibility = 'hidden';

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } else {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â div.className = 'block';

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (block) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â div.classList.add(block.isFixed ? 'fixed' : 'user-placed');

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â div.innerHTML = `<img src="images/block_${block.id}_${block.face}.png" class="block-image" style="transform: rotate(${block.rot * 90}deg);" draggable="false">`;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const edgeZone = document.createElement('div');

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â edgeZone.className = 'zone-edge'; edgeZone.onclick = (e) => { e.stopPropagation(); rotateBlock(i); };

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â div.appendChild(edgeZone);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (!block.isFixed) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const centerZone = document.createElement('div');

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â centerZone.className = 'zone-center'; centerZone.onclick = (e) => { e.stopPropagation(); flipBlock(i); };

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const startLongPress = () => { longPressTimer = setTimeout(() => clearBlock(i), 600); }, cancelLongPress = () => clearTimeout(longPressTimer);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â centerZone.addEventListener('mousedown', startLongPress); centerZone.addEventListener('touchstart', startLongPress);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â centerZone.addEventListener('mouseup', cancelLongPress); centerZone.addEventListener('touchend', cancelLongPress);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â centerZone.addEventListener('mouseleave', cancelLongPress);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â div.appendChild(centerZone);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } else {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â div.innerHTML = '+'; div.className = 'empty-slot'; div.onclick = () => openPicker(i);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â container.appendChild(div);

Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â updateGlowsAndWin();

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function rotateBlock(index) { if (userBoard[index] && !isRoundWon) { userBoard[index].rot = (userBoard[index].rot + 1) % 4; playSound('action'); renderGameGrid(); } }

Â Â Â Â Â Â Â Â function flipBlock(index) { if (userBoard[index] && !userBoard[index].isFixed && !isRoundWon) { userBoard[index].face = userBoard[index].face === 'B' ? 'W' : 'B'; playSound('action'); renderGameGrid(); } }

Â Â Â Â Â Â Â Â function clearBlock(index) { if (isRoundWon) return; userBoard[index] = null; playSound('action'); renderGameGrid(); }

Â Â Â Â Â Â Â Â 

Â Â Â Â Â Â Â Â function getAvailableBlocks() { const used = new Set(); userBoard.forEach(b => { if(b) used.add(b.id); }); return [1,2,3,4,5,6,7,8,9].filter(id => !used.has(id)); }


Â Â Â Â Â Â Â Â function openPicker(index) { if (isRoundWon) return; pickingSlot = index; pickerFace = 'B'; renderPickerGrid(); $('picker-modal').style.display = 'flex'; }

Â Â Â Â Â Â Â Â function togglePickerFace() { pickerFace = (pickerFace === 'B') ? 'W' : 'B'; renderPickerGrid(); }


Â Â Â Â Â Â Â Â function renderPickerGrid() {

Â Â Â Â Â Â Â Â Â Â Â Â const grid = $('picker-grid');

Â Â Â Â Â Â Â Â Â Â Â Â $('picker-title').innerText = `é¸æ“‡é­”çŸ³ (${pickerFace}é¢)`; grid.innerHTML = '';

Â Â Â Â Â Â Â Â Â Â Â Â getAvailableBlocks().forEach(id => {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const div = document.createElement('div'); div.className = 'picker-item';

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â div.innerHTML = `<img src="images/block_${id}_${pickerFace}.png">`;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â div.onclick = () => { userBoard[pickingSlot] = { id: id, face: pickerFace, rot: 0, isFixed: false }; playSound('action'); closePicker(); renderGameGrid(); };

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â grid.appendChild(div);

Â Â Â Â Â Â Â Â Â Â Â Â });

Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â function closePicker() { $('picker-modal').style.display = 'none'; }


Â Â Â Â Â Â Â Â // --- é©—è­‰èˆ‡å…‰æšˆ ---

Â Â Â Â Â Â Â Â function getRotatedMatrix(m, times) {

Â Â Â Â Â Â Â Â Â Â Â Â for (let t = 0; t < times; t++) m = [[m[1][0], m[0][0]], [m[1][1], m[0][1]]];

Â Â Â Â Â Â Â Â Â Â Â Â return m;

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function getFullGrid(boardState = userBoard) {

Â Â Â Â Â Â Â Â Â Â Â Â let fullGrid = Array(6).fill().map(() => Array(6).fill(0));

Â Â Â Â Â Â Â Â Â Â Â Â for(let i=0; i<9; i++) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if(!boardState[i]) continue;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â let b = boardState[i], r = Math.floor(i / 3) * 2, c = (i % 3) * 2;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â let matrix = getRotatedMatrix(BLOCKS[b.id][b.face], b.rot);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â fullGrid[r][c] = matrix[0][0]; fullGrid[r][c+1] = matrix[0][1];

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â fullGrid[r+1][c] = matrix[1][0]; fullGrid[r+1][c+1] = matrix[1][1];

Â Â Â Â Â Â Â Â Â Â Â Â } return fullGrid;

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function isLineValid(grid, idx, isRow) {

Â Â Â Â Â Â Â Â Â Â Â Â let values = [];

Â Â Â Â Â Â Â Â Â Â Â Â for (let k = 0; k < 6; k++) { const val = isRow ? grid[idx][k] : grid[k][idx]; if (val !== 0) values.push(val); }

Â Â Â Â Â Â Â Â Â Â Â Â return values.length > 0 && new Set(values).size === values.length;

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function isValid(boardState) {

Â Â Â Â Â Â Â Â Â Â Â Â let grid = getFullGrid(boardState);

Â Â Â Â Â Â Â Â Â Â Â Â for (let i = 0; i < 6; i++) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â let rSet = new Set(), cSet = new Set();

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â for (let j = 0; j < 6; j++) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â let rVal = grid[i][j], cVal = grid[j][i];

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (rVal !== 0) { if (rSet.has(rVal)) return false; rSet.add(rVal); }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (cVal !== 0) { if (cSet.has(cVal)) return false; cSet.add(cVal); }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â } return true;

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function updateGlowsAndWin() {

Â Â Â Â Â Â Â Â Â Â Â Â const glowLayer = $('glow-layer'), grid = getFullGrid(); glowLayer.innerHTML = '';

Â Â Â Â Â Â Â Â Â Â Â Â let currentValidLineCount = 0;

Â Â Â Â Â Â Â Â Â Â Â Â 

Â Â Â Â Â Â Â Â Â Â Â Â for (let r = 0; r < 3; r++) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â let cnt = (userBoard[r*3]?1:0) + (userBoard[r*3+1]?1:0) + (userBoard[r*3+2]?1:0);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (cnt > 1 && isLineValid(grid, r*2, true) && isLineValid(grid, r*2+1, true)) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const glow = document.createElement('div'); glow.className = 'glow-bar glow-row'; glow.style.top = (r * 33.33 + 0.5) + '%';

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â glowLayer.appendChild(glow); currentValidLineCount++;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â for (let c = 0; c < 3; c++) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â let cnt = (userBoard[c]?1:0) + (userBoard[c+3]?1:0) + (userBoard[c+6]?1:0);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (cnt > 1 && isLineValid(grid, c*2, false) && isLineValid(grid, c*2+1, false)) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const glow = document.createElement('div'); glow.className = 'glow-bar glow-col'; glow.style.left = (c * 33.33 + 0.5) + '%';

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â glowLayer.appendChild(glow); currentValidLineCount++;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (currentValidLineCount > lastValidLineCount) playSound('line');

Â Â Â Â Â Â Â Â Â Â Â Â lastValidLineCount = currentValidLineCount;


Â Â Â Â Â Â Â Â Â Â Â Â const isFull = userBoard.every((b, i) => currentLayoutConfig[i].type === 'EMPTY' || b !== null);

Â Â Â Â Â Â Â Â Â Â Â Â if (isFull && isValid(userBoard) && !isRoundWon) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â isRoundWon = true; clearInterval(timerInterval); playSound('win');

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const spent = Math.floor((Date.now() - roundStartTime) / 1000);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (spent <= 60) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â setTimeout(() => playSound('bonus'), 800);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â let levelInfo = $('level-info');

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â levelInfo.innerText += ` â­ é€Ÿé€šé”æˆ (+${ROUND_SETTINGS[currentRound].bonus}åˆ†)`; levelInfo.style.color = "#f1c40f";

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â $('grid-container').classList.add('win-glow');

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â $('btn-next').style.display = 'inline-block'; $('action-controls').style.display = 'none';Â 

Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â // --- æ±‚è§£èˆ‡è¼”åŠ© ---

Â Â Â Â Â Â Â Â function forceSolve(manual = true) {

Â Â Â Â Â Â Â Â Â Â Â Â clearInterval(timerInterval);

Â Â Â Â Â Â Â Â Â Â Â Â let solverBoard = Array(9).fill(null), usedIDs = new Set();

Â Â Â Â Â Â Â Â Â Â Â Â for(let i=0; i<9; i++) if (currentLayoutConfig[i].type === 'FIXED') usedIDs.add(currentLayoutConfig[i].id);

Â Â Â Â Â Â Â Â Â Â Â Â 

Â Â Â Â Â Â Â Â Â Â Â Â setTimeout(() => {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (solveStep(0, solverBoard, usedIDs)) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â userBoard = solverBoard; renderGameGrid();

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â $('grid-container').classList.add('win-glow');

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â $('btn-solve').disabled = true; $('btn-reset').disabled = true;Â 

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â $('btn-next').style.display = 'inline-block'; $('action-controls').style.display = 'none';

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â isRoundWon = true; isSolverUsed = true;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (manual) { let lvl = $('level-info'); lvl.innerText = "ä½¿ç”¨ç¦å¿Œé­”æ³•ï¼Œæœ¬é—œä¸è¨ˆåˆ†"; lvl.style.color = "#e74c3c"; }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } else { alert("ç„¡æ³•å°å°ï¼"); }

Â Â Â Â Â Â Â Â Â Â Â Â }, 100);

Â Â Â Â Â Â Â Â }


Â Â Â Â Â Â Â Â function solveStep(idx, board, usedIDs, dryRun = false) {

Â Â Â Â Â Â Â Â Â Â Â Â if (idx >= 9) return true;

Â Â Â Â Â Â Â Â Â Â Â Â const config = currentLayoutConfig[idx];

Â Â Â Â Â Â Â Â Â Â Â Â if (config.type === 'EMPTY') return solveStep(idx + 1, board, usedIDs, dryRun);

Â Â Â Â Â Â Â Â Â Â Â Â if (config.type === 'FIXED') {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const { id, face } = config;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â for (let rot = 0; rot < 4; rot++) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â board[idx] = { id, face, rot, isFixed: true };

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (isValid(board) && solveStep(idx + 1, board, usedIDs, dryRun)) return true;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â board[idx] = null; return false;

Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â if (config.type === 'SOLVE') {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â for (let id = 1; id <= 9; id++) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (!usedIDs.has(id)) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â usedIDs.add(id);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â for (let face of ['B', 'W']) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â for (let rot = 0; rot < 4; rot++) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â board[idx] = { id, face, rot, isFixed: false };

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (isValid(board) && solveStep(idx + 1, board, usedIDs, dryRun)) return true;

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â board[idx] = null; usedIDs.delete(id);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return false;

Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â Â return false;

Â Â Â Â Â Â Â Â }

Â Â Â Â </script>

</body>

</html>
