<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‰²ç¨å°å°æ³•å…¸ (æ¡ŒéŠç‰ˆ)</title>
    <style>
        /* --- 1. åŸºç¤è¨­å®š --- */
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            user-select: none;
            -webkit-user-select: none; /* iOS é˜²é¸å– */
            touch-action: manipulation;
        }

        h1 { margin-bottom: 10px; color: #333; letter-spacing: 2px; }

        /* --- 2. æ§åˆ¶é¢æ¿ --- */
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
            width: 95%;
            box-sizing: border-box;
        }

        .step-title {
            font-size: 1.1rem;
            color: #2c3e50;
            margin: 15px 0 10px 0;
            font-weight: bold;
            text-align: left;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        /* --- 3. æŒ‰éˆ•èˆ‡ç¶²æ ¼é¸æ“‡å™¨ --- */
        .level-selector {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            background: #eee;
            padding: 4px;
            border-radius: 8px;
        }

        .level-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px 0;
            cursor: pointer;
            border-radius: 6px;
            font-weight: bold;
            color: #666;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .level-btn.active { background-color: #3498db; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .grid-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .img-btn {
            background-color: white;
            border: 2px solid #eee;
            border-radius: 8px;
            cursor: pointer;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            transition: transform 0.1s;
        }

        .img-btn:active { transform: scale(0.95); }
        .img-btn.active { border-color: #f1c40f; background-color: #fffcf0; box-shadow: 0 0 5px rgba(241, 196, 15, 0.5); }
        #tile-buttons .img-btn.active { border-color: #e67e22; background-color: #fdf2e9; }
        
        .img-btn img { width: 80%; height: 80%; object-fit: contain; }
        .btn-label { margin-top: 2px; font-size: 0.7rem; color: #555; font-weight: bold; }

        /* --- 4. éŠæˆ²å€ (ä¹å®®æ ¼) --- */
        .main-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            background-color: #333;
            padding: 10px;
            border-radius: 12px;
            width: 100%;
            max-width: 380px;
            aspect-ratio: 1 / 1;
            box-sizing: border-box;
            margin: 0 auto;
            position: relative;
        }

        /* å‹åˆ©å…‰èŠ’ç‰¹æ•ˆ */
        .main-grid.win-glow {
            box-shadow: 0 0 25px 8px rgba(255, 215, 0, 0.8);
            border: 2px solid #ffd700;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.6); }
            50% { box-shadow: 0 0 30px 10px rgba(255, 215, 0, 1); }
            100% { box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.6); }
        }

        .block {
            background-color: #fff;
            border: 2px solid transparent;
            position: relative;
            border-radius: 5px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1 / 1;
        }

        .block.fixed { border-color: #e74c3c; background-color: #fff5f5; } /* ç›®æ¨™æ–¹å¡Š(ç´…æ¡†) */
        .block.user-placed { border-color: #3498db; } /* ç©å®¶æ–¹å¡Š(è—æ¡†) */
        
        .block-image { width: 100%; height: 100%; object-fit: contain; transition: transform 0.2s ease; }
        .empty-slot { background-color: #e0e0e0; color: #bbb; font-size: 2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; }

        /* äº’å‹•å±¤ (è¦†è“‹åœ¨æ–¹å¡Šä¸Š) */
        .interaction-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
        }
        /* é‚Šç·£ (æ—‹è½‰) */
        .zone-edge { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 11; }
        /* ä¸­å¿ƒ (ç¿»è½‰/æ›´æ›) */
        .zone-center { 
            position: absolute; top: 20%; left: 20%; width: 60%; height: 60%; 
            z-index: 12; border-radius: 50%; 
            /* background: rgba(0,0,0,0.1); æ¸¬è©¦ç”¨ */
        }

        /* --- 5. åº•éƒ¨æŒ‰éˆ•èˆ‡ç‹€æ…‹ --- */
        .status-msg { margin: 15px 0; font-weight: bold; font-size: 1.1rem; min-height: 24px; color: #333; }
        .success-msg { color: #f39c12; font-size: 1.3rem; text-shadow: 0 0 2px #fff; }
        
        .solve-btn {
            background-color: #7f8c8d;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .solve-btn:hover { background-color: #95a5a6; }

        /* --- 6. å½ˆå‡ºé¸å–® (Picker) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 999;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 12px; width: 85%; max-width: 350px; text-align: center;
        }
        .picker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .picker-item { border: 1px solid #ddd; border-radius: 5px; padding: 3px; cursor: pointer; }
        .picker-item img { width: 100%; }

    </style>
</head>
<body>

    <h1>ğŸ”® è‰²ç¨å°å°æ³•å…¸</h1>
    
    <div class="controls">
        
        <div class="step-title">æ­¥é©Ÿ 1ï¼šé¸æ“‡é­”çŸ³çµ„åˆ (Tiles) ğŸ’</div>
        <div class="level-selector" id="tile-level-buttons">
            <button class="level-btn" onclick="filterTilesByLevel(1)">Level I</button>
            <button class="level-btn" onclick="filterTilesByLevel(2)">II</button>
            <button class="level-btn" onclick="filterTilesByLevel(3)">III</button>
            <button class="level-btn" onclick="filterTilesByLevel(4)">IV</button>
            <button class="level-btn" onclick="filterTilesByLevel(5)">V</button>
            <button class="level-btn" onclick="filterTilesByLevel(6)">VI</button>
        </div>
        <div class="grid-selector" id="tile-buttons"></div>

        <div class="step-title">æ­¥é©Ÿ 2ï¼šé¸æ“‡å°å°æ³•é™£ (Shapes) ğŸ”¯</div>
        <div class="level-selector" id="shape-level-buttons">
            <button class="level-btn" onclick="filterShapesByLevel(1)">Level I</button>
            <button class="level-btn" onclick="filterShapesByLevel(2)">II</button>
            <button class="level-btn" onclick="filterShapesByLevel(3)">III</button>
            <button class="level-btn" onclick="filterShapesByLevel(4)">IV</button>
            <button class="level-btn" onclick="filterShapesByLevel(5)">V</button>
            <button class="level-btn" onclick="filterShapesByLevel(6)">VI</button>
        </div>
        <div class="grid-selector" id="shape-buttons"></div>

        <div class="step-title">æ­¥é©Ÿ 3ï¼šæ‰‹å‹•èª¿æ•´é­”çŸ³ ğŸ´</div>
        <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">é»æ“Šé‚Šç·£æ—‹è½‰ | é»æ“Šä¸­å¿ƒæˆ–æ»‘å‹•ç¿»é¢</div>
        
        <div id="grid-container" class="main-grid"></div>
        <div id="status-text" class="status-msg">è«‹é¸æ“‡é¡Œç›®...</div>

        <button id="btn-solve" class="solve-btn" onclick="forceSolve()">ğŸ”“ å•Ÿå‹•å°å°è§£ç­” âœ¨</button>
    </div>

    <div id="picker-modal" class="modal-overlay" onclick="closePicker()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>é¸æ“‡è¦æ”¾å…¥çš„é­”çŸ³</h3>
            <div id="picker-grid" class="picker-grid"></div>
            <button onclick="closePicker()" style="margin-top:15px; padding:10px 30px; background:#ddd; border:none; border-radius:20px; font-size:1rem;">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- è³‡æ–™å®šç¾© ---
        const BLOCKS = {
            1: { B: [[1,2],[3,4]], W: [[4,3],[6,5]] },
            2: { B: [[3,4],[5,6]], W: [[6,5],[2,1]] },
            3: { B: [[5,6],[1,2]], W: [[2,1],[4,3]] },
            4: { B: [[2,3],[5,6]], W: [[5,4],[2,1]] },
            5: { B: [[4,5],[1,2]], W: [[1,6],[4,3]] },
            6: { B: [[6,1],[3,4]], W: [[3,2],[6,5]] },
            7: { B: [[4,5],[6,1]], W: [[1,6],[3,2]] },
            8: { B: [[6,1],[2,3]], W: [[3,2],[5,4]] },
            9: { B: [[2,3],[4,5]], W: [[5,4],[1,6]] }
        };

        const TARGET_TILES = [
            { id: 1,  level: 1, blocks: [{id:1, f:'B'}, {id:5, f:'B'}, {id:8, f:'W'}] },
            { id: 2,  level: 1, blocks: [{id:2, f:'B'}, {id:9, f:'B'}, {id:6, f:'W'}] },
            { id: 3,  level: 1, blocks: [{id:6, f:'B'}, {id:1, f:'W'}, {id:7, f:'B'}] },
            { id: 4,  level: 1, blocks: [{id:9, f:'W'}, {id:3, f:'B'}, {id:4, f:'W'}] },
            { id: 5,  level: 1, blocks: [{id:2, f:'W'}, {id:7, f:'W'}, {id:4, f:'B'}] },
            { id: 6,  level: 1, blocks: [{id:5, f:'W'}, {id:3, f:'W'}, {id:8, f:'B'}] },
            { id: 7,  level: 2, blocks: [{id:5, f:'B'}, {id:3, f:'B'}, {id:9, f:'W'}] },
            { id: 8,  level: 2, blocks: [{id:1, f:'B'}, {id:5, f:'W'}, {id:8, f:'B'}] },
            { id: 9,  level: 2, blocks: [{id:4, f:'B'}, {id:8, f:'B'}, {id:2, f:'W'}] },
            { id: 10, level: 2, blocks: [{id:3, f:'B'}, {id:6, f:'W'}, {id:7, f:'W'}] },
            { id: 11, level: 2, blocks: [{id:9, f:'W'}, {id:6, f:'B'}, {id:1, f:'W'}] },
            { id: 12, level: 2, blocks: [{id:4, f:'W'}, {id:2, f:'W'}, {id:7, f:'B'}] },
            { id: 13, level: 3, blocks: [{id:3, f:'B'}, {id:4, f:'B'}, {id:7, f:'W'}] },
            { id: 14, level: 3, blocks: [{id:9, f:'B'}, {id:4, f:'W'}, {id:1, f:'B'}] },
            { id: 15, level: 3, blocks: [{id:7, f:'B'}, {id:5, f:'B'}, {id:2, f:'W'}] },
            { id: 16, level: 3, blocks: [{id:6, f:'W'}, {id:8, f:'W'}, {id:2, f:'B'}] },
            { id: 17, level: 3, blocks: [{id:5, f:'B'}, {id:8, f:'W'}, {id:3, f:'W'}] },
            { id: 18, level: 3, blocks: [{id:1, f:'W'}, {id:9, f:'B'}, {id:6, f:'W'}] },
            { id: 19, level: 4, blocks: [{id:2, f:'B'}, {id:6, f:'B'}, {id:9, f:'W'}] },
            { id: 20, level: 4, blocks: [{id:7, f:'B'}, {id:4, f:'W'}, {id:3, f:'B'}] },
            { id: 21, level: 4, blocks: [{id:9, f:'B'}, {id:4, f:'B'}, {id:1, f:'W'}] },
            { id: 22, level: 4, blocks: [{id:1, f:'B'}, {id:8, f:'W'}, {id:4, f:'W'}] },
            { id: 23, level: 4, blocks: [{id:9, f:'W'}, {id:5, f:'B'}, {id:2, f:'W'}] },
            { id: 24, level: 4, blocks: [{id:8, f:'B'}, {id:6, f:'W'}, {id:2, f:'W'}] },
            { id: 25, level: 5, blocks: [{id:1, f:'B'}, {id:6, f:'B'}, {id:7, f:'W'}] },
            { id: 26, level: 5, blocks: [{id:3, f:'B'}, {id:8, f:'B'}, {id:6, f:'W'}] },
            { id: 27, level: 5, blocks: [{id:5, f:'B'}, {id:9, f:'B'}, {id:3, f:'W'}] },
            { id: 28, level: 5, blocks: [{id:1, f:'B'}, {id:5, f:'W'}, {id:7, f:'W'}] },
            { id: 29, level: 5, blocks: [{id:8, f:'W'}, {id:4, f:'B'}, {id:1, f:'W'}] },
            { id: 30, level: 5, blocks: [{id:3, f:'W'}, {id:4, f:'W'}, {id:9, f:'B'}] },
            { id: 31, level: 6, blocks: [{id:4, f:'B'}, {id:2, f:'B'}, {id:8, f:'W'}] },
            { id: 32, level: 6, blocks: [{id:2, f:'B'}, {id:5, f:'W'}, {id:7, f:'B'}] },
            { id: 33, level: 6, blocks: [{id:8, f:'B'}, {id:6, f:'B'}, {id:3, f:'W'}] },
            { id: 34, level: 6, blocks: [{id:5, f:'W'}, {id:2, f:'B'}, {id:9, f:'W'}] },
            { id: 35, level: 6, blocks: [{id:3, f:'W'}, {id:7, f:'W'}, {id:6, f:'B'}] },
            { id: 36, level: 6, blocks: [{id:7, f:'B'}, {id:5, f:'W'}, {id:1, f:'W'}] }
        ];

        const SHAPES = [
            { id: 1, name: "No.001", level: 1, active: [2,3,4,7,9], targets: [2,4,9] },
            { id: 2, name: "No.002", level: 1, active: [2,4,6,7,8], targets: [2,6,7] },
            { id: 3, name: "No.003", level: 1, active: [1,3,5,8,9], targets: [1,5,9] },
            { id: 4, name: "No.004", level: 1, active: [1,3,4,8,9], targets: [3,4,8] },
            { id: 5, name: "No.005", level: 1, active: [1,2,4,6,8], targets: [1,6,8] },
            { id: 6, name: "No.006", level: 1, active: [1,3,5,7,8], targets: [3,5,7] },
            { id: 7, name: "No.007", level: 2, active: [2,4,5,8,9], targets: [2,4,9] },
            { id: 8, name: "No.008", level: 2, active: [2,6,7,8,9], targets: [2,6,7] },
            { id: 9, name: "No.009", level: 2, active: [1,2,5,8,9], targets: [1,5,9] },
            { id: 10, name: "No.010", level: 2, active: [2,3,4,5,8], targets: [3,4,8] },
            { id: 11, name: "No.011", level: 2, active: [1,2,3,6,8], targets: [1,6,8] },
            { id: 12, name: "No.012", level: 2, active: [2,3,5,7,8], targets: [3,5,7] },
            { id: 13, name: "No.013", level: 3, active: [2,4,6,7,8,9], targets: [2,4,9] },
            { id: 14, name: "No.014", level: 3, active: [2,4,5,6,7,9], targets: [2,6,7] },
            { id: 15, name: "No.015", level: 3, active: [1,3,5,7,8,9], targets: [1,5,9] },
            { id: 16, name: "No.016", level: 3, active: [2,3,4,6,8,9], targets: [3,4,8] },
            { id: 17, name: "No.017", level: 3, active: [1,2,5,6,7,8], targets: [1,6,8] },
            { id: 18, name: "No.018", level: 3, active: [1,3,5,6,7,9], targets: [3,5,7] },
            { id: 19, name: "No.019", level: 4, active: [2,4,5,6,8,9], targets: [2,4,9] },
            { id: 20, name: "No.020", level: 4, active: [2,5,6,7,8,9], targets: [2,6,7] },
            { id: 21, name: "No.021", level: 4, active: [1,2,3,5,6,9], targets: [1,5,9] },
            { id: 22, name: "No.022", level: 4, active: [2,3,4,5,6,8], targets: [3,4,8] },
            { id: 23, name: "No.023", level: 4, active: [1,2,3,5,6,8], targets: [1,6,8] },
            { id: 24, name: "No.024", level: 4, active: [1,2,3,4,5,7], targets: [3,5,7] },
            { id: 25, name: "No.025", level: 5, active: [1,2,4,5,6,8,9], targets: [2,4,9] },
            { id: 26, name: "No.026", level: 5, active: [1,2,4,6,7,8,9], targets: [2,6,7] },
            { id: 27, name: "No.027", level: 5, active: [1,3,5,6,7,8,9], targets: [1,5,9] },
            { id: 28, name: "No.028", level: 5, active: [2,3,4,5,6,7,8], targets: [3,4,8] },
            { id: 29, name: "No.029", level: 5, active: [2,3,4,5,6,7,8], targets: [1,6,8] },
            { id: 30, name: "No.030", level: 5, active: [1,2,3,4,6,8,9], targets: [3,5,7] },
            { id: 31, name: "No.031", level: 6, active: [1,2,3,4,6,7,9], targets: [2,4,9] },
            { id: 32, name: "No.032", level: 6, active: [2,4,5,6,7,8,9], targets: [2,6,7] },
            { id: 33, name: "No.033", level: 6, active: [1,3,4,5,6,7,9], targets: [1,5,9] },
            { id: 34, name: "No.034", level: 6, active: [1,2,3,6,7,8,9], targets: [3,4,8] },
            { id: 35, name: "No.035", level: 6, active: [1,2,3,4,6,7,9], targets: [1,6,8] },
            { id: 36, name: "No.036", level: 6, active: [1,2,3,4,7,8,9], targets: [3,5,7] }
        ];

        // --- å…¨åŸŸè®Šæ•¸ ---
        let currentTileID = 1;
        let currentShapeID = 1;
        let currentLayoutConfig = {}; 
        let userBoard = Array(9).fill(null);
        let pickingSlot = -1;
        let longPressTimer;

        // --- åˆå§‹åŒ– ---
        function init() {
            filterTilesByLevel(1);
            filterShapesByLevel(1);
            selectTile(1);
            selectShape(1);
        }

        // --- ä»‹é¢æ¸²æŸ“ ---
        function filterTilesByLevel(level) {
            updateLevelBtns('tile-level-buttons', level);
            renderButtons('tile-buttons', TARGET_TILES.filter(t => t.level === level), 'tile', selectTile, currentTileID);
        }

        function filterShapesByLevel(level) {
            updateLevelBtns('shape-level-buttons', level);
            renderButtons('shape-buttons', SHAPES.filter(s => s.level === level), 'shape', selectShape, currentShapeID);
        }

        function renderButtons(containerId, dataList, type, clickHandler, currentId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            dataList.forEach((item) => {
                const btn = document.createElement('div');
                btn.className = 'img-btn';
                if(item.id === currentId) btn.classList.add('active');
                btn.onclick = () => clickHandler(item.id);
                
                const paddedID = String(item.id).padStart(3, '0');
                const imgPath = `images/${type}_${paddedID}.png`;
                const label = item.name || `No.${paddedID}`;
                
                btn.innerHTML = `<img src="${imgPath}" alt="${label}" onerror="this.style.display='none'"><div class="btn-label">${label}</div>`;
                container.appendChild(btn);
            });
            if (dataList.length > 0 && !dataList.some(i => i.id === currentId)) {
                clickHandler(dataList[0].id);
            }
        }

        function updateLevelBtns(containerId, activeLevel) {
            document.getElementById(containerId).querySelectorAll('.level-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx + 1 === activeLevel);
            });
        }

        function updateActiveState(containerId, activeId, type) {
            const paddedId = String(activeId).padStart(3, '0');
            const targetText = `No.${paddedId}`;
            const container = document.getElementById(containerId);
            container.querySelectorAll('.img-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText.includes(targetText));
            });
        }

        function selectTile(id) {
            currentTileID = id;
            updateActiveState('tile-buttons', id, 'tile');
            setupGame();
        }

        function selectShape(id) {
            currentShapeID = id;
            updateActiveState('shape-buttons', id, 'shape');
            setupGame();
        }

        // --- éŠæˆ²é‚è¼¯ ---
        function setupGame() {
            const shape = SHAPES.find(s => s.id === currentShapeID);
            const tile = TARGET_TILES.find(t => t.id === currentTileID);
            if(!shape || !tile) return;

            currentLayoutConfig = {};
            for(let i=0; i<9; i++) currentLayoutConfig[i] = { type: 'EMPTY' };
            shape.active.forEach(pos => { currentLayoutConfig[pos-1] = { type: 'SOLVE' }; });
            
            // è¨­å®šç›®æ¨™
            shape.targets.forEach((pos, idx) => {
                if (idx < tile.blocks.length) {
                    const blockDef = tile.blocks[idx];
                    currentLayoutConfig[pos-1] = { 
                        type: 'FIXED', 
                        id: blockDef.id, 
                        face: blockDef.f 
                    };
                } else {
                    currentLayoutConfig[pos-1] = { type: 'SOLVE' };
                }
            });

            // åˆå§‹åŒ–ç›¤é¢
            userBoard = Array(9).fill(null);
            for(let i=0; i<9; i++) {
                if (currentLayoutConfig[i].type === 'FIXED') {
                    userBoard[i] = { 
                        id: currentLayoutConfig[i].id, 
                        face: currentLayoutConfig[i].face, 
                        rot: 0, 
                        isFixed: true 
                    };
                }
            }

            document.getElementById('status-text').innerHTML = "éŠæˆ²é–‹å§‹";
            document.getElementById('grid-container').classList.remove('win-glow');
            document.getElementById('btn-solve').style.display = 'block';
            renderGameGrid();
        }

        function renderGameGrid() {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';

            for(let i=0; i<9; i++) {
                const config = currentLayoutConfig[i];
                const block = userBoard[i];
                const div = document.createElement('div');
                
                if (config.type === 'EMPTY') {
                    div.className = 'block empty-slot';
                    div.style.visibility = 'hidden';
                } else {
                    div.className = 'block';
                    
                    if (block) {
                        if (block.isFixed) div.classList.add('fixed');
                        else div.classList.add('user-placed');

                        const imagePath = `images/block_${block.id}_${block.face}.png`;
                        const rot = block.rot * 90;
                        div.innerHTML = `<img src="${imagePath}" class="block-image" style="transform: rotate(${rot}deg);" draggable="false">`;

                        // äº’å‹•å±¤
                        const edgeZone = document.createElement('div');
                        edgeZone.className = 'zone-edge';
                        edgeZone.onclick = (e) => { e.stopPropagation(); rotateBlock(i); };
                        div.appendChild(edgeZone);

                        // å¦‚æœä¸æ˜¯å›ºå®šæ–¹å¡Šï¼ŒåŠ å…¥ä¸­å¿ƒäº’å‹•(ç¿»é¢/æ›å¡Š)
                        if (!block.isFixed) {
                            const centerZone = document.createElement('div');
                            centerZone.className = 'zone-center';
                            
                            // é»æ“Šç¿»è½‰
                            centerZone.onclick = (e) => { e.stopPropagation(); flipBlock(i); };

                            // é•·æŒ‰æ›å¡Š
                            const startLongPress = () => { longPressTimer = setTimeout(() => changeBlock(i), 600); };
                            const cancelLongPress = () => clearTimeout(longPressTimer);

                            centerZone.addEventListener('mousedown', startLongPress);
                            centerZone.addEventListener('touchstart', startLongPress);
                            centerZone.addEventListener('mouseup', cancelLongPress);
                            centerZone.addEventListener('mouseleave', cancelLongPress);
                            centerZone.addEventListener('touchend', cancelLongPress);

                            // æ»‘å‹•ç¿»è½‰
                            let startX = 0;
                            centerZone.addEventListener('touchstart', e => startX = e.touches[0].clientX);
                            centerZone.addEventListener('touchend', e => {
                                if (Math.abs(e.changedTouches[0].clientX - startX) > 30) flipBlock(i);
                            });

                            div.appendChild(centerZone);
                        }
                    } else {
                        div.innerHTML = '<span style="color:#ccc; font-size:2rem;">?</span>';
                        div.className = 'block empty-slot';
                        div.onclick = () => openPicker(i);
                    }
                }
                container.appendChild(div);
            }
            checkWin();
        }

        // --- äº’å‹•åŠŸèƒ½ ---
        function rotateBlock(index) {
            if (userBoard[index]) {
                userBoard[index].rot = (userBoard[index].rot + 1) % 4;
                renderGameGrid();
            }
        }

        function flipBlock(index) {
            if (userBoard[index] && !userBoard[index].isFixed) {
                userBoard[index].face = userBoard[index].face === 'B' ? 'W' : 'B';
                renderGameGrid();
            }
        }

        function changeBlock(index) {
            const currentId = userBoard[index].id;
            const available = getAvailableBlocks();
            available.push(currentId);
            available.sort((a,b) => a-b);
            let nextIndex = available.indexOf(currentId) + 1;
            if (nextIndex >= available.length) nextIndex = 0;
            userBoard[index].id = available[nextIndex];
            renderGameGrid();
        }

        // --- Picker ---
        function getAvailableBlocks() {
            const usedIds = new Set();
            userBoard.forEach(b => { if(b) usedIds.add(b.id); });
            const allIds = [1,2,3,4,5,6,7,8,9];
            return allIds.filter(id => !usedIds.has(id));
        }

        function openPicker(index) {
            pickingSlot = index;
            const available = getAvailableBlocks();
            const grid = document.getElementById('picker-grid');
            grid.innerHTML = '';

            if (available.length === 0) {
                grid.innerHTML = '<p style="grid-column:span 3">ç„¡å¯ç”¨æ–¹å¡Š<br>è«‹é•·æŒ‰ç¾æœ‰æ–¹å¡Šæ›´æ›</p>';
            }

            available.forEach(id => {
                const div = document.createElement('div');
                div.className = 'picker-item';
                div.innerHTML = `<img src="images/block_${id}_B.png">`;
                div.onclick = () => {
                    userBoard[pickingSlot] = { id: id, face: 'B', rot: 0, isFixed: false };
                    closePicker();
                    renderGameGrid();
                };
                grid.appendChild(div);
            });
            document.getElementById('picker-modal').style.display = 'flex';
        }

        function closePicker() { document.getElementById('picker-modal').style.display = 'none'; }

        // --- é©—è­‰èˆ‡æ±‚è§£ ---
        function getRotatedMatrix(matrix, times) {
            let m = JSON.parse(JSON.stringify(matrix));
            for (let t = 0; t < times; t++) {
                const newM = [[0,0],[0,0]];
                newM[0][1] = m[0][0]; newM[1][1] = m[0][1];
                newM[1][0] = m[1][1]; newM[0][0] = m[1][0];
                m = newM;
            }
            return m;
        }

        function isValid(boardState) {
            let fullGrid = Array(6).fill().map(() => Array(6).fill(0));
            // æª¢æŸ¥å®Œæ•´æ€§
            for(let i=0; i<9; i++) {
                if (currentLayoutConfig[i].type !== 'EMPTY' && !boardState[i]) return false;
            }
            // å¡«å…¥
            for(let i=0; i<9; i++) {
                if(!boardState[i]) continue;
                let b = boardState[i];
                let baseRow = Math.floor(i / 3) * 2;
                let baseCol = (i % 3) * 2;
                let matrix = getRotatedMatrix(BLOCKS[b.id][b.face], b.rot);
                fullGrid[baseRow][baseCol] = matrix[0][0]; fullGrid[baseRow][baseCol+1] = matrix[0][1];
                fullGrid[baseRow+1][baseCol] = matrix[1][0]; fullGrid[baseRow+1][baseCol+1] = matrix[1][1];
            }
            // æª¢æŸ¥é„°æ¥
            for (let i = 0; i < 6; i++) {
                let rowSeen = new Set(), colSeen = new Set();
                for (let j = 0; j < 6; j++) {
                    let rVal = fullGrid[i][j];
                    if (rVal !== 0) { if (rowSeen.has(rVal)) return false; rowSeen.add(rVal); }
                    let cVal = fullGrid[j][i];
                    if (cVal !== 0) { if (colSeen.has(cVal)) return false; colSeen.add(cVal); }
                }
            }
            return true;
        }

        function checkWin() {
            const isFull = userBoard.every((b, i) => currentLayoutConfig[i].type === 'EMPTY' || b !== null);
            if (isFull && isValid(userBoard)) {
                document.getElementById('grid-container').classList.add('win-glow');
                document.getElementById('status-text').innerHTML = "<span class='success-msg'>ğŸ‰ å°å°æˆåŠŸï¼</span>";
                document.getElementById('btn-solve').style.display = 'none';
            } else {
                document.getElementById('grid-container').classList.remove('win-glow');
                document.getElementById('status-text').innerText = isFull ? "âŒ å°å°å¤±æ•— (é¡è‰²è¡çª)" : "è§£é¡Œä¸­...";
            }
        }

        // --- å¼·åˆ¶æ±‚è§£ ---
        function forceSolve() {
            document.getElementById('status-text').innerText = "ğŸ”® æ­£åœ¨è®€å–å¤©å•Ÿ...";
            
            // æº–å‚™è³‡æ–™ï¼šå›ºå®šæ–¹å¡Š(ID+Faceå›ºå®šï¼Œæ—‹è½‰æœªçŸ¥)ï¼Œç©ºç™½æ ¼(å…¨æœªçŸ¥)
            let solverBoard = Array(9).fill(null);
            let usedIDs = new Set();
            
            for(let i=0; i<9; i++) {
                if (currentLayoutConfig[i].type === 'FIXED') {
                    // ç›®æ¨™æ–¹å¡Šï¼šé–å®š ID èˆ‡ Face
                    solverBoard[i] = { 
                        id: currentLayoutConfig[i].id, 
                        face: currentLayoutConfig[i].face, 
                        rot: 0, // åˆå§‹ 0ï¼Œè®“ solver å»è½‰
                        isFixed: true 
                    };
                    usedIDs.add(solverBoard[i].id);
                }
            }

            setTimeout(() => {
                if (solveRecursively(solverBoard, usedIDs)) {
                    userBoard = solverBoard; 
                    renderGameGrid();
                    document.getElementById('status-text').innerHTML = "<span style='color:blue'>âœ… å·²é¡¯ç¤ºè§£ç­”</span>";
                    document.getElementById('grid-container').classList.add('win-glow');
                } else {
                    document.getElementById('status-text').innerText = "âŒ æ­¤é¡Œç„¡è§£";
                }
            }, 100);
        }

        function solveRecursively(board, usedIDs) {
            // æ‰¾ä¸‹ä¸€å€‹éœ€è¦è™•ç†çš„æ ¼å­ (åŒ…å«å°šæœªç¢ºå®šæ—‹è½‰çš„ FIXED æ ¼å­)
            // é€™è£¡ç°¡åŒ–é‚è¼¯ï¼šå¦‚æœæ˜¯ FIXEDï¼Œæˆ‘å€‘å˜—è©¦ 4 å€‹æ–¹å‘ã€‚å¦‚æœæ˜¯ NULLï¼Œæˆ‘å€‘å˜—è©¦æ‰€æœ‰æ–¹å¡Š+æ–¹å‘ã€‚
            
            // ç‚ºäº†éè¿´æ–¹ä¾¿ï¼Œæˆ‘å€‘æ‰¾ç¬¬ä¸€å€‹ "æœªå®Œæˆ" çš„æ ¼å­ã€‚
            // ä½†é€™è£¡å› ç‚º board æ··åˆäº† null å’Œ objectï¼Œæˆ‘å€‘ç”¨ index éæ­·
            return solveStep(0, board, usedIDs);
        }

        function solveStep(idx, board, usedIDs) {
            if (idx >= 9) return isValidPartially(board); // æª¢æŸ¥é‚Šç•Œæ¢ä»¶

            // å¦‚æœæ˜¯ EMPTY æ ¼å­ï¼Œç›´æ¥è·³é
            if (currentLayoutConfig[idx].type === 'EMPTY') {
                return solveStep(idx + 1, board, usedIDs);
            }

            // è™•ç†ç•¶å‰æ ¼å­
            if (board[idx] && board[idx].isFixed) {
                // FIXED æ–¹å¡Šï¼šå˜—è©¦ 4 ç¨®æ—‹è½‰
                let originalRot = board[idx].rot;
                for (let r = 0; r < 4; r++) {
                    board[idx].rot = r;
                    if (isValidPartially(board)) {
                        if (solveStep(idx + 1, board, usedIDs)) return true;
                    }
                }
                board[idx].rot = originalRot; // Backtrack
                return false;
            } else if (board[idx] === null) {
                // ç©ºç™½æ ¼ï¼šå˜—è©¦æ‰€æœ‰æœªä½¿ç”¨çš„æ–¹å¡Š
                for (let id = 1; id <= 9; id++) {
                    if (!usedIDs.has(id)) {
                        usedIDs.add(id);
                        // å˜—è©¦ B/W é¢
                        for (let face of ['B', 'W']) {
                            // å˜—è©¦ 4 ç¨®æ—‹è½‰
                            for (let rot = 0; rot < 4; rot++) {
                                board[idx] = { id, face, rot, isFixed: false };
                                if (isValidPartially(board)) {
                                    if (solveStep(idx + 1, board, usedIDs)) return true;
                                }
                            }
                        }
                        board[idx] = null; // Backtrack
                        usedIDs.delete(id);
                    }
                }
                return false;
            } else {
                // å·²ç¶“å¡«äº† User Block (ç†è«–ä¸Š Solver æ‡‰è©²é‡ç®—ï¼Œé€™è£¡è¦–ç‚ºå·²å¡«)
                // ç‚ºäº†å¼·åˆ¶è§£é¡Œï¼ŒSolver æ‡‰è©²è¦†è“‹ User çš„éŒ¯èª¤ç­”æ¡ˆã€‚
                // ç°¡å–®èµ·è¦‹ï¼ŒSolver å…¶å¯¦æ˜¯å¾é ­ç®—ä¸€éï¼Œæ‰€ä»¥ä¸Šé¢çš„ logic é©ç”¨æ–¼å…¨æ–°ç›¤é¢ã€‚
                // å¦‚æœæ˜¯ forceSolve å‘¼å«çš„ï¼Œboard åªæœ‰ Fixedï¼Œå…¶ä»–æ˜¯ nullã€‚
                return solveStep(idx + 1, board, usedIDs); 
            }
        }

        // éƒ¨åˆ†æª¢æŸ¥ (å…è¨±ç©ºä½)
        function isValidPartially(boardState) {
             let fullGrid = Array(6).fill().map(() => Array(6).fill(0));
             for(let i=0; i<9; i++) {
                if(!boardState[i]) continue;
                let b = boardState[i];
                let baseRow = Math.floor(i / 3) * 2;
                let baseCol = (i % 3) * 2;
                let matrix = getRotatedMatrix(BLOCKS[b.id][b.face], b.rot);
                fullGrid[baseRow][baseCol] = matrix[0][0]; fullGrid[baseRow][baseCol+1] = matrix[0][1];
                fullGrid[baseRow+1][baseCol] = matrix[1][0]; fullGrid[baseRow+1][baseCol+1] = matrix[1][1];
            }
            for (let i = 0; i < 6; i++) {
                let rowSeen = new Set(), colSeen = new Set();
                for (let j = 0; j < 6; j++) {
                    let rVal = fullGrid[i][j];
                    if (rVal !== 0) { if (rowSeen.has(rVal)) return false; rowSeen.add(rVal); }
                    let cVal = fullGrid[j][i];
                    if (cVal !== 0) { if (colSeen.has(cVal)) return false; colSeen.add(cVal); }
                }
            }
            return true;
        }

        init();
    </script>
</body>
</html>


