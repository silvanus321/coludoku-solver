<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‰²ç¨å°å°å¸« (2.0 åˆ†ç´šç‰ˆ)</title>
    <style>
        /* --- 1. åŸºç¤è¨­å®š --- */
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background-color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin: 0;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            color: white;
            min-height: 100vh;
        }

        .header-box { position: relative; width: 100%; max-width: 400px; text-align: center; margin: 10px 0; }
        h1 { margin: 0; letter-spacing: 2px; font-size: 1.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3); display: inline-block; }

        /* --- 2. HUD & æ™‚é–“æ¢ --- */
        .hud {
            display: grid; grid-template-columns: 1fr 1fr 1fr; width: 100%; max-width: 400px;
            background: rgba(255, 255, 255, 0.1); padding: 10px 15px; border-radius: 50px;
            margin-bottom: 5px; box-sizing: border-box; backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2); align-items: center; text-align: center;
        }
        .hud-item { font-weight: bold; font-size: 0.85rem; }
        .hud-val { color: #f1c40f; display: block; font-family: monospace; font-size: 1.2rem; }
        .hud-val.urgent { color: #e74c3c; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .time-bar-container {
            width: 100%; max-width: 380px; height: 10px; background: rgba(0,0,0,0.4);
            border-radius: 5px; margin-bottom: 15px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1);
        }
        .time-bar-fill { height: 100%; width: 100%; background-color: #3498db; transition: width 1s linear, background-color 0.3s ease; box-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .time-bar-fill.state-purple { background-color: #9b59b6; box-shadow: 0 0 15px #8e44ad, 0 0 5px #fff; animation: electric 0.2s infinite alternate; }
        .time-bar-fill.state-blue { background-color: #3498db; box-shadow: 0 0 5px #2980b9; }
        .time-bar-fill.state-red { background-color: #c0392b; box-shadow: 0 0 15px #e74c3c; animation: shakeBar 0.5s infinite; }
        @keyframes electric { 0% { opacity: 1; box-shadow: 0 0 15px #8e44ad; } 100% { opacity: 0.8; box-shadow: 0 0 25px #d2b4de; } }
        @keyframes shakeBar { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-1px); opacity: 0.8; } 75% { transform: translateX(1px); opacity: 1; } }

        .level-info { margin-top: 5px; font-size: 0.9rem; color: #f1c40f; min-height: 20px; font-weight: bold; text-align: center;}
        .instruction-bar { font-size: 0.85rem; color: #bdc3c7; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 20px; margin-bottom: 10px; white-space: nowrap; text-align: center; }

        /* --- 3. éŠæˆ²å€ --- */
        .game-container { position: relative; width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; }
        .main-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;
            background-color: #34495e; padding: 10px; border-radius: 12px;
            width: 100%; aspect-ratio: 1 / 1; box-sizing: border-box; position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .main-grid.win-glow { box-shadow: 0 0 30px 10px rgba(241, 196, 15, 0.6); border: 2px solid #f1c40f; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 15px 5px rgba(241, 196, 15, 0.4); } 50% { box-shadow: 0 0 30px 15px rgba(241, 196, 15, 0.8); } }

        .block {
            background-color: #ecf0f1; border: 2px solid transparent; position: relative;
            border-radius: 6px; overflow: hidden; display: flex; justify-content: center; align-items: center; aspect-ratio: 1 / 1;
        }
        .block.fixed { border-color: #c0392b; background-color: #fadbd8; }
        .block.user-placed { border-color: #2980b9; }
        .block-image { width: 100%; height: 100%; object-fit: contain; transition: transform 0.2s ease; }
        .empty-slot { background-color: rgba(0,0,0,0.2); color: #7f8c8d; font-size: 2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; border: 2px dashed rgba(255,255,255,0.1); }
        .zone-edge { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 11; }
        .zone-center { position: absolute; top: 20%; left: 20%; width: 60%; height: 60%; z-index: 12; border-radius: 50%; }

        /* å…‰æšˆå±¤ */
        .glow-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; border-radius: 12px; overflow: hidden; }
        .glow-bar { position: absolute; box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.5); border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 8px; transition: opacity 0.3s; }
        .glow-row { left: 1%; width: 98%; height: 31%; background: linear-gradient(to bottom, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0) 25%, rgba(255,255,255,0) 75%, rgba(255,255,255,0.5) 100%); }
        .glow-col { top: 1%; height: 98%; width: 31%; background: linear-gradient(to right, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0) 25%, rgba(255,255,255,0) 75%, rgba(255,255,255,0.5) 100%); }

        /* --- 4. é¸å–®èˆ‡æŒ‰éˆ• --- */
        .action-btn { background-color: #27ae60; color: white; border: none; padding: 15px 40px; font-size: 1.1rem; border-radius: 50px; cursor: pointer; margin-top: 25px; width: 80%; transition: all 0.2s; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .action-btn:active { transform: scale(0.95); }
        
        .button-group { display: flex; justify-content: space-between; width: 100%; margin-top: 20px; gap: 15px; }
        .action-btn.btn-reset { background-color: #16a085; font-size: 1rem; padding: 10px; flex: 1; margin-top: 0; }
        .action-btn.btn-reset:hover { background-color: #1abc9c; }
        .action-btn.give-up { background-color: #7f8c8d; font-size: 1rem; padding: 10px; flex: 1; margin-top: 0; }
        .action-btn.give-up:hover { background-color: #95a5a6; }
        .action-btn.failed { background-color: #c0392b; cursor: not-allowed; }

        /* ç­‰ç´šé¸æ“‡éˆ• */
        .lvl-btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 300px; margin: 20px auto; }
        .lvl-btn { background: #34495e; border: 2px solid #bdc3c7; color: #ecf0f1; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 1rem;}
        .lvl-btn small { font-size: 0.75rem; color: #95a5a6; display: block; margin-top: 4px; font-weight: normal;}
        .lvl-btn.active { background: #f1c40f; border-color: #f39c12; color: #2c3e50; box-shadow: 0 0 15px rgba(241, 196, 15, 0.5); }
        .lvl-btn.active small { color: #555; }

        .name-input { padding: 15px; border-radius: 10px; border: none; font-size: 1.2rem; width: 70%; text-align: center; margin-bottom: 20px; background: rgba(255,255,255,0.9); }

        /* --- 5. å½ˆçª—èˆ‡æ’è¡Œæ¦œ --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); overflow-y: auto; }
        .modal-content { background: white; color: #333; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-height: 95vh; overflow-y: auto; }
        .picker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .picker-item { border: 1px solid #ddd; border-radius: 8px; padding: 5px; cursor: pointer; }
        .picker-item img { width: 100%; }

        .leaderboard-box { margin-top: 20px; text-align: left; }
        .lb-title { font-size: 1rem; color: #555; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px; font-weight: bold; }
        .lb-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .lb-table th { text-align: left; color: #888; padding: 5px; font-size: 0.8rem; }
        .lb-table td { padding: 6px 5px; border-bottom: 1px solid #f0f0f0; }
        .lb-rank { font-weight: bold; color: #27ae60; width: 25px; }
        .lb-name { font-weight: bold; }
        .lb-score { color: #e67e22; text-align: right; }
        .lb-time { color: #7f8c8d; text-align: right; font-family: monospace; }
        .best-levels { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .bl-item { background: #f9f9f9; padding: 5px; border-radius: 5px; font-size: 0.8rem; border: 1px solid #eee; }
        .bl-lvl { font-weight: bold; color: #3498db; }

        #start-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: #2c3e50; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .intro-box { text-align: center; padding: 20px; width: 100%; box-sizing: border-box;}
        .intro-title { font-size: 2.5rem; color: #f1c40f; margin-bottom: 10px; letter-spacing: 3px; }
        .intro-desc { font-size: 1.1rem; color: #ecf0f1; margin-bottom: 20px; line-height: 1.8; }
    </style>
</head>
<body>

    <div id="start-screen">
        <div class="intro-box">
            <div class="intro-title">ğŸ”®è‰²ç¨å°å°å¸«ğŸ”®</div>
            <div class="intro-desc"><strong>è¡Œåˆ—å¯¶çŸ³ç›¸ç•°ï¼Œå®Œæˆè‰²ç¨å°å°</strong></div>
            
            <div class="lvl-btn-group">
                <button class="lvl-btn" onclick="selectLevel(0, this)">LEVEL 0<br><small>Shape 37-48</small></button>
                <button class="lvl-btn active" onclick="selectLevel(1, this)">LEVEL 1<br><small>Shape 01-12</small></button>
                <button class="lvl-btn" onclick="selectLevel(2, this)">LEVEL 2<br><small>Shape 13-24</small></button>
                <button class="lvl-btn" onclick="selectLevel(3, this)">LEVEL 3<br><small>Shape 25-36</small></button>
            </div>

            <input type="text" id="player-name" class="name-input" placeholder="è«‹è¼¸å…¥å°å°å¸«åè™Ÿ" maxlength="10">
            <button class="action-btn" onclick="startGame()" style="margin-top: 0;">é–‹å§‹æŒ‘æˆ°</button>
        </div>
    </div>

    <div class="header-box">
        <h1 id="game-title">Round 1</h1>
    </div>
    
    <div class="hud">
        <div class="hud-item">é—œå¡ <span id="round-disp" class="hud-val">1/6</span></div>
        <div class="hud-item">å€’æ•¸ <span id="timer-disp" class="hud-val">04:00</span></div>
        <div class="hud-item">å¾—åˆ† <span id="score-disp" class="hud-val">0</span></div>
    </div>

    <div class="time-bar-container">
        <div id="time-bar-fill" class="time-bar-fill"></div>
    </div>

    <div class="game-container">
        <div class="level-info" id="level-info"></div>
        <div class="instruction-bar">ğŸ‘†è¼•é»ä¸­é–“ç¿»é¢ | ğŸ”„è¼•é»é‚Šç·£æ—‹è½‰ | ğŸ—‘ï¸é•·æŒ‰ä¸­é–“ç§»é™¤</div>

        <div id="grid-container" class="main-grid"></div>
        
        <button id="btn-next" class="action-btn" style="display:none;" onclick="nextLevel()">ä¸‹ä¸€é—œ â¡ï¸</button>
        
        <div id="action-controls" class="button-group">
            <button id="btn-reset" class="action-btn btn-reset" onclick="resetLevel()">ğŸ”„ é‡ç½® (é‚„åŸé­”æ³•)</button>
            <button id="btn-solve" class="action-btn give-up" onclick="forceSolve(true)">ğŸ³ï¸ æ”¾æ£„ (çœ‹è§£ç­”)</button>
        </div>
    </div>

    <div id="picker-modal" class="modal-overlay" onclick="closePicker()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="picker-title">é¸æ“‡é­”çŸ³ (Bé¢)</h3>
            <div id="picker-grid" class="picker-grid"></div>
            <div style="margin-top:15px; display:flex; justify-content:center; gap:10px;">
                <button onclick="togglePickerFace()" style="padding:10px 20px; background:#9b59b6; color:white; border:none; border-radius:20px; font-weight:bold;">ğŸ”„ ç¿»é¢</button>
                <button onclick="closePicker()" style="padding:10px 20px; background:#ddd; border:none; border-radius:20px;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="end-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="end-title" style="margin:5px 0;">æŒ‘æˆ°çµæŸ</h2>
            <div style="background:#f4f6f7; padding:10px; border-radius:10px; margin-bottom:15px;">
                <div style="font-size:1.1rem; color:#2c3e50; font-weight:bold;" id="end-player-name"></div>
                <div style="display:flex; justify-content:space-around; margin-top:5px;">
                    <div>å¾—åˆ† <span id="end-score" style="color:#27ae60; font-weight:bold;">0 / 100</span></div>
                    <div>ç¸½è€—æ™‚ <span id="end-time" style="color:#e67e22; font-weight:bold;">00:00</span></div>
                </div>
                <div id="end-msg" style="margin-top:5px; font-size:0.9rem; color:#555;"></div>
            </div>

            <div class="leaderboard-box">
                <div class="lb-title">ğŸ† æ’è¡Œæ¦œ (TOP 10)</div>
                <table class="lb-table">
                    <thead><tr><th>#</th><th>åå­—</th><th>åˆ†</th><th>æ™‚</th></tr></thead>
                    <tbody id="lb-body"></tbody>
                </table>
            </div>

            <div class="leaderboard-box">
                <div class="lb-title">âš¡ å„ç´šå‚³èªª</div>
                <div id="best-levels-grid" class="best-levels"></div>
            </div>

            <button class="action-btn" style="margin-top:20px; padding:10px 30px;" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // --- 0. éŸ³æ•ˆç³»çµ± ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'action') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'line') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(1200, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.3);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            } else if (type === 'win') {
                playNote(523.25, now, 0.1); playNote(659.25, now + 0.1, 0.1); playNote(783.99, now + 0.2, 0.4); 
            } else if (type === 'bonus') {
                playNote(880, now, 0.1); playNote(1760, now + 0.1, 0.2); 
            } else if (type === 'reset') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(800, now + 0.2);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        }
        function playNote(freq, time, dur) {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'square'; osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, time); gain.gain.exponentialRampToValueAtTime(0.01, time + dur);
            osc.start(time); osc.stop(time + dur);
        }

        // --- 1. è³‡æ–™åº« ---
        const BLOCKS = {
            1: { B: [[1,2],[3,4]], W: [[5,6],[3,4]] },
            2: { B: [[4,6],[3,5]], W: [[2,6],[1,5]] },
            3: { B: [[2,1],[6,5]], W: [[3,4],[1,2]] },
            4: { B: [[5,2],[6,3]], W: [[4,1],[5,2]] },
            5: { B: [[4,5],[1,2]], W: [[3,4],[6,1]] },
            6: { B: [[1,4],[6,3]], W: [[6,3],[5,2]] },
            7: { B: [[1,6],[5,4]], W: [[2,3],[6,1]] },
            8: { B: [[2,6],[3,1]], W: [[2,4],[3,5]] },
            9: { B: [[2,3],[4,5]], W: [[6,1],[4,5]] }
        };

        const TARGET_TILES = [
            { id: 1,  blocks: [{id:1, f:'B'}, {id:5, f:'B'}, {id:9, f:'B'}] },
            { id: 2,  blocks: [{id:2, f:'B'}, {id:6, f:'B'}, {id:7, f:'B'}] },
            { id: 3,  blocks: [{id:3, f:'B'}, {id:4, f:'B'}, {id:8, f:'B'}] },
            { id: 4,  blocks: [{id:3, f:'B'}, {id:5, f:'B'}, {id:7, f:'B'}] },
            { id: 5,  blocks: [{id:1, f:'B'}, {id:6, f:'B'}, {id:8, f:'B'}] },
            { id: 6,  blocks: [{id:2, f:'B'}, {id:4, f:'B'}, {id:9, f:'B'}] },
            { id: 7,  blocks: [{id:1, f:'B'}, {id:5, f:'B'}, {id:8, f:'W'}] },
            { id: 8,  blocks: [{id:2, f:'B'}, {id:9, f:'B'}, {id:6, f:'W'}] },
            { id: 9,  blocks: [{id:6, f:'B'}, {id:1, f:'W'}, {id:7, f:'B'}] },
            { id: 10, blocks: [{id:9, f:'W'}, {id:3, f:'B'}, {id:4, f:'W'}] },
            { id: 11, blocks: [{id:2, f:'W'}, {id:7, f:'W'}, {id:4, f:'B'}] },
            { id: 12, blocks: [{id:5, f:'W'}, {id:3, f:'W'}, {id:8, f:'B'}] },
            { id: 13, blocks: [{id:5, f:'B'}, {id:3, f:'B'}, {id:9, f:'W'}] },
            { id: 14, blocks: [{id:1, f:'B'}, {id:5, f:'W'}, {id:8, f:'B'}] },
            { id: 15, blocks: [{id:4, f:'B'}, {id:8, f:'B'}, {id:2, f:'W'}] },
            { id: 16, blocks: [{id:3, f:'B'}, {id:6, f:'W'}, {id:7, f:'W'}] },
            { id: 17, blocks: [{id:9, f:'W'}, {id:6, f:'B'}, {id:1, f:'W'}] },
            { id: 18, blocks: [{id:4, f:'W'}, {id:2, f:'W'}, {id:7, f:'B'}] },
            { id: 19, blocks: [{id:3, f:'B'}, {id:4, f:'B'}, {id:7, f:'W'}] },
            { id: 20, blocks: [{id:9, f:'B'}, {id:4, f:'W'}, {id:1, f:'B'}] },
            { id: 21, blocks: [{id:7, f:'B'}, {id:5, f:'B'}, {id:2, f:'W'}] },
            { id: 22, blocks: [{id:6, f:'W'}, {id:8, f:'W'}, {id:2, f:'B'}] },
            { id: 23, blocks: [{id:5, f:'B'}, {id:8, f:'W'}, {id:3, f:'W'}] },
            { id: 24, blocks: [{id:1, f:'W'}, {id:9, f:'B'}, {id:6, f:'W'}] },
            { id: 25, blocks: [{id:2, f:'B'}, {id:6, f:'B'}, {id:9, f:'W'}] },
            { id: 26, blocks: [{id:7, f:'B'}, {id:4, f:'W'}, {id:3, f:'B'}] },
            { id: 27, blocks: [{id:9, f:'B'}, {id:4, f:'B'}, {id:1, f:'W'}] },
            { id: 28, blocks: [{id:1, f:'B'}, {id:8, f:'W'}, {id:4, f:'W'}] },
            { id: 29, blocks: [{id:9, f:'W'}, {id:5, f:'B'}, {id:2, f:'W'}] },
            { id: 30, blocks: [{id:8, f:'B'}, {id:6, f:'W'}, {id:2, f:'W'}] },
            { id: 31, blocks: [{id:1, f:'B'}, {id:6, f:'B'}, {id:7, f:'W'}] },
            { id: 32, blocks: [{id:3, f:'B'}, {id:8, f:'B'}, {id:6, f:'W'}] },
            { id: 33, blocks: [{id:5, f:'B'}, {id:9, f:'B'}, {id:3, f:'W'}] },
            { id: 34, blocks: [{id:1, f:'B'}, {id:5, f:'W'}, {id:7, f:'W'}] },
            { id: 35, blocks: [{id:8, f:'W'}, {id:4, f:'B'}, {id:1, f:'W'}] },
            { id: 36, blocks: [{id:3, f:'W'}, {id:4, f:'W'}, {id:9, f:'B'}] },
            { id: 37, blocks: [{id:4, f:'B'}, {id:2, f:'B'}, {id:8, f:'W'}] },
            { id: 38, blocks: [{id:2, f:'B'}, {id:5, f:'W'}, {id:7, f:'B'}] },
            { id: 39, blocks: [{id:8, f:'B'}, {id:6, f:'B'}, {id:3, f:'W'}] },
            { id: 40, blocks: [{id:5, f:'W'}, {id:2, f:'B'}, {id:9, f:'W'}] },
            { id: 41, blocks: [{id:3, f:'W'}, {id:7, f:'W'}, {id:6, f:'B'}] },
            { id: 42, blocks: [{id:7, f:'B'}, {id:5, f:'W'}, {id:1, f:'W'}] },
            { id: 43, blocks: [{id:1, f:'W'}, {id:5, f:'W'}, {id:9, f:'W'}] },
            { id: 44, blocks: [{id:2, f:'W'}, {id:6, f:'W'}, {id:7, f:'W'}] },
            { id: 45, blocks: [{id:3, f:'W'}, {id:4, f:'W'}, {id:8, f:'W'}] },
            { id: 46, blocks: [{id:3, f:'W'}, {id:5, f:'W'}, {id:7, f:'W'}] },
            { id: 47, blocks: [{id:1, f:'W'}, {id:6, f:'W'}, {id:8, f:'W'}] },
            { id: 48, blocks: [{id:2, f:'W'}, {id:4, f:'W'}, {id:9, f:'W'}] }
        ];

        const SHAPES = [
            { id: 1, name: "No.001", active: [2,3,4,7,9], targets: [2,4,9] },
            { id: 2, name: "No.002", active: [2,4,6,7,8], targets: [2,6,7] },
            { id: 3, name: "No.003", active: [1,3,5,8,9], targets: [1,5,9] },
            { id: 4, name: "No.004", active: [1,3,4,8,9], targets: [3,4,8] },
            { id: 5, name: "No.005", active: [1,2,4,6,8], targets: [1,6,8] },
            { id: 6, name: "No.006", active: [1,3,5,7,8], targets: [3,5,7] },
            { id: 7, name: "No.007", active: [2,4,5,8,9], targets: [2,4,9] },
            { id: 8, name: "No.008", active: [2,6,7,8,9], targets: [2,6,7] },
            { id: 9, name: "No.009", active: [1,2,5,8,9], targets: [1,5,9] },
            { id: 10, name: "No.010", active: [2,3,4,5,8], targets: [3,4,8] },
            { id: 11, name: "No.011", active: [1,2,3,6,8], targets: [1,6,8] },
            { id: 12, name: "No.012", active: [2,3,5,7,8], targets: [3,5,7] },
            { id: 13, name: "No.013", active: [2,4,6,7,8,9], targets: [2,4,9] },
            { id: 14, name: "No.014", active: [2,4,5,6,7,9], targets: [2,6,7] },
            { id: 15, name: "No.015", active: [1,3,5,7,8,9], targets: [1,5,9] },
            { id: 16, name: "No.016", active: [2,3,4,6,8,9], targets: [3,4,8] },
            { id: 17, name: "No.017", active: [1,2,5,6,7,8], targets: [1,6,8] },
            { id: 18, name: "No.018", active: [1,3,5,6,7,9], targets: [3,5,7] },
            { id: 19, name: "No.019", active: [2,4,5,6,8,9], targets: [2,4,9] },
            { id: 20, name: "No.020", active: [2,5,6,7,8,9], targets: [2,6,7] },
            { id: 21, name: "No.021", active: [1,2,3,5,6,9], targets: [1,5,9] },
            { id: 22, name: "No.022", active: [2,3,4,5,6,8], targets: [3,4,8] },
            { id: 23, name: "No.023", active: [1,2,3,5,6,8], targets: [1,6,8] },
            { id: 24, name: "No.024", active: [1,2,3,4,5,7], targets: [3,5,7] },
            { id: 25, name: "No.025", active: [1,2,4,5,6,8,9], targets: [2,4,9] },
            { id: 26, name: "No.026", active: [1,2,4,6,7,8,9], targets: [2,6,7] },
            { id: 27, name: "No.027", active: [1,3,5,6,7,8,9], targets: [1,5,9] },
            { id: 28, name: "No.028", active: [2,3,4,5,6,7,8], targets: [3,4,8] },
            { id: 29, name: "No.029", active: [1,2,3,4,6,8,9], targets: [1,6,8] },
            { id: 30, name: "No.030", active: [1,3,4,5,7,8,9], targets: [3,5,7] },
            { id: 31, name: "No.031", active: [1,2,3,4,6,7,9], targets: [2,4,9] },
            { id: 32, name: "No.032", active: [2,4,5,6,7,8,9], targets: [2,6,7] },
            { id: 33, name: "No.033", active: [1,3,4,5,6,7,9], targets: [1,5,9] },
            { id: 34, name: "No.034", active: [1,2,3,4,7,8,9], targets: [3,4,8] },
            { id: 35, name: "No.035", active: [1,2,4,5,6,7,8], targets: [1,6,8] },
            { id: 36, name: "No.036", active: [1,2,3,5,7,8,9], targets: [3,5,7] },
            { id: 37, name: "No.037", active: [2,3,4,9], targets: [2,4,9] },
            { id: 38, name: "No.038", active: [2,4,6,7], targets: [2,6,7] },
            { id: 39, name: "No.039", active: [1,3,5,9], targets: [1,5,9] },
            { id: 40, name: "No.040", active: [1,3,4,8], targets: [3,4,8] },
            { id: 41, name: "No.041", active: [1,2,6,8], targets: [1,6,8] },
            { id: 42, name: "No.042", active: [1,3,5,7], targets: [3,5,7] },
            { id: 43, name: "No.043", active: [2,4,7,9], targets: [2,4,9] },
            { id: 44, name: "No.044", active: [2,6,7,8], targets: [2,6,7] },
            { id: 45, name: "No.045", active: [1,5,8,9], targets: [1,5,9] },
            { id: 46, name: "No.046", active: [3,4,8,9], targets: [3,4,8] },
            { id: 47, name: "No.047", active: [1,4,6,8], targets: [1,6,8] },
            { id: 48, name: "No.048", active: [3,5,7,8], targets: [3,5,7] }
        ];

        // 6é—œéšæ¢¯å¼è¨­å®šï¼šç§’æ•¸, é€šé—œåŸºç¤åˆ†, é€Ÿé€šåŠ åˆ†
        const ROUND_SETTINGS = {
            1: { time: 240, base: 12, bonus: 1 },
            2: { time: 210, base: 12, bonus: 2 },
            3: { time: 180, base: 13, bonus: 3 },
            4: { time: 150, base: 13, bonus: 4 },
            5: { time: 120, base: 14, bonus: 5 },
            6: { time: 90,  base: 14, bonus: 6 }
        };

        // --- è®Šæ•¸ ---
        let playerName = "";
        let selectedLevel = 1; // é è¨­ Level 1
        let roundPool = [];    // å­˜æ”¾éš¨æ©ŸæŠ½å–çš„ 6 é¡Œ Shape
        
        let currentRound = 1;
        let totalScore = 0;
        let totalTimeSpent = 0; 
        let roundStartTime = 0; 
        let currentLayoutConfig = {};
        let userBoard = Array(9).fill(null);
        let pickingSlot = -1;
        let isRoundWon = false;
        let isSolverUsed = false;
        let timerInterval;
        let timeLeft = 0;
        let currentTotalTime = 0; 
        let lastValidLineCount = 0;
        let longPressTimer;
        let pickerFace = 'B'; 

        // --- æ ¸å¿ƒæµç¨‹ ---
        function selectLevel(lvl, btn) {
            selectedLevel = lvl;
            document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            playSound('action');
        }

        function getShapesByLevel(lvl) {
            let pool = [];
            if (lvl === 0) pool = SHAPES.filter(s => s.id >= 37 && s.id <= 48);
            else if (lvl === 1) pool = SHAPES.filter(s => s.id >= 1 && s.id <= 12);
            else if (lvl === 2) pool = SHAPES.filter(s => s.id >= 13 && s.id <= 24);
            else if (lvl === 3) pool = SHAPES.filter(s => s.id >= 25 && s.id <= 36);
            // éš¨æ©Ÿæ´—ç‰Œä¸¦å– 6 é¡Œ
            return pool.sort(() => Math.random() - 0.5).slice(0, 6);
        }

        function startGame() {
            const nameInput = document.getElementById('player-name').value.trim();
            if (!nameInput) { alert("è«‹è¼¸å…¥å°å°å¸«åè™Ÿï¼"); return; }
            
            // å…è¨±æ’­æ”¾éŸ³æ•ˆ
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            playerName = nameInput;
            document.getElementById('start-screen').style.display = 'none';
            
            currentRound = 1;
            totalScore = 0;
            totalTimeSpent = 0;
            
            roundPool = getShapesByLevel(selectedLevel);
            
            updateHUD();
            loadRound(currentRound);
        }

        function loadRound(round) {
            isRoundWon = false;
            isSolverUsed = false;
            lastValidLineCount = 0;
            
            document.getElementById('game-title').innerText = `Round ${round}`;
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('action-controls').style.display = 'flex';
            document.getElementById('btn-solve').style.display = 'block';
            document.getElementById('btn-reset').style.display = 'block';
            document.getElementById('btn-solve').disabled = false;
            document.getElementById('btn-solve').innerText = "ğŸ³ï¸ æ”¾æ£„ (çœ‹è§£ç­”)";
            document.getElementById('btn-solve').className = "action-btn give-up"; 
            document.getElementById('btn-reset').disabled = false;
            
            document.getElementById('grid-container').classList.remove('win-glow');
            document.getElementById('timer-disp').classList.remove('urgent');

            const config = ROUND_SETTINGS[round];
            startTimer(config.time);
            roundStartTime = Date.now();

            let solvable = false;
            let attempts = 0;
            let selectedShape, selectedTile;

            // å–å‡ºè©²å›åˆçš„ Shape (é™£åˆ— index å¾ 0 é–‹å§‹)
            selectedShape = roundPool[round - 1];

            while (!solvable && attempts < 50) {
                selectedTile = TARGET_TILES[Math.floor(Math.random() * TARGET_TILES.length)];
                currentLayoutConfig = {};
                for(let i=0; i<9; i++) currentLayoutConfig[i] = { type: 'EMPTY' };
                
                selectedShape.active.forEach(pos => { currentLayoutConfig[pos-1] = { type: 'SOLVE' }; });
                selectedShape.targets.forEach((pos, idx) => {
                    if (idx < selectedTile.blocks.length) {
                        const b = selectedTile.blocks[idx];
                        currentLayoutConfig[pos-1] = { type: 'FIXED', id: b.id, face: b.f };
                    } else {
                        currentLayoutConfig[pos-1] = { type: 'SOLVE' };
                    }
                });
                if (checkSolvability()) solvable = true;
                attempts++;
            }
            if (!solvable) { alert("ç”Ÿæˆå¤±æ•—"); return; }

            document.getElementById('level-info').innerText = `${selectedShape.name} (é€šé—œ+${config.base}åˆ† | é€Ÿé€š+${config.bonus}åˆ†)`;
            document.getElementById('level-info').style.color = "#f1c40f"; 
            
            userBoard = Array(9).fill(null);
            for(let i=0; i<9; i++) {
                if (currentLayoutConfig[i].type === 'FIXED') {
                    userBoard[i] = { id: currentLayoutConfig[i].id, face: currentLayoutConfig[i].face, rot: 0, isFixed: true };
                }
            }
            renderGameGrid();
        }

        function startTimer(seconds) {
            clearInterval(timerInterval);
            timeLeft = seconds;
            currentTotalTime = seconds; 
            updateTimerDisplay();
            updateTimeBar(); 

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                updateTimeBar();

                if (timeLeft <= 10) document.getElementById('timer-disp').classList.add('urgent');
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeOut();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer-disp').innerText = `${m}:${s}`;
        }

        function updateTimeBar() {
            const bar = document.getElementById('time-bar-fill');
            const pct = (timeLeft / currentTotalTime) * 100;
            bar.style.width = `${pct}%`;
            bar.classList.remove('state-purple', 'state-blue', 'state-red');

            if (pct > 70) {
                bar.classList.add('state-purple');
            } else if (pct < 30) {
                bar.classList.add('state-red');
            } else {
                bar.classList.add('state-blue');
            }
        }

        function handleTimeOut() {
            if (isRoundWon) return;
            calculateTimeSpent();
            forceSolve(false);
            document.getElementById('btn-solve').innerText = "âŒ› æŒ‘æˆ°å¤±æ•—";
            document.getElementById('btn-solve').className = "action-btn failed";
            document.getElementById('btn-reset').style.display = 'none'; 
            document.getElementById('level-info').innerText = "æ™‚é–“è€—ç›¡ï¼Œæœ¬é—œä¸è¨ˆåˆ†";
            document.getElementById('level-info').style.color = "#e74c3c";
        }

        function checkSolvability() {
            let solverBoard = Array(9).fill(null);
            let usedIDs = new Set();
            for(let i=0; i<9; i++) {
                if (currentLayoutConfig[i].type === 'FIXED') usedIDs.add(currentLayoutConfig[i].id);
            }
            return solveStep(0, solverBoard, usedIDs, true);
        }

        function calculateTimeSpent() {
            let spent = Math.floor((Date.now() - roundStartTime) / 1000);
            totalTimeSpent += spent;
            // ç´€éŒ„è©²ç­‰ç´šçš„æœ€ä½³é€šé—œæ™‚é–“ (ç¸½æ™‚é–“)
            if (isRoundWon && !isSolverUsed) updateLevelBest(selectedLevel, totalTimeSpent);
            return spent;
        }

        function nextLevel() {
            clearInterval(timerInterval);
            const spent = calculateTimeSpent(); 
            
            if (!isSolverUsed) {
                const config = ROUND_SETTINGS[currentRound];
                let roundScore = config.base;
                // å¦‚æœé€šé—œèŠ±è²»æ™‚é–“å°æ–¼è©²é—œå¡ç¸½æ™‚é–“çš„ä¸€å®šæ¯”ä¾‹(æ¯”å¦‚é€Ÿé€šè¨­å®šç‚º60ç§’å…§)
                // åŸéœ€æ±‚ï¼šé€Ÿé€šçµ¦äºˆé¡å¤–åŠ åˆ†
                if (spent <= 60) {
                    roundScore += config.bonus;
                }
                totalScore += roundScore;
            }
            
            updateHUD();
            currentRound++;
            if (currentRound > 6) showEndScreen();
            else loadRound(currentRound);
        }

        function updateHUD() {
            document.getElementById('round-disp').innerText = `${currentRound} / 6`;
            document.getElementById('score-disp').innerText = totalScore;
        }

        function resetLevel() {
            if (isRoundWon || isSolverUsed) return;
            playSound('reset');
            for (let i = 0; i < 9; i++) {
                if (currentLayoutConfig[i].type === 'FIXED') {
                    userBoard[i].rot = 0;
                    userBoard[i].face = currentLayoutConfig[i].face; 
                } else {
                    userBoard[i] = null;
                }
            }
            renderGameGrid();
            lastValidLineCount = 0;
        }

        // --- æ’è¡Œæ¦œ ---
        function saveRecord() {
            const record = { name: playerName, score: totalScore, time: totalTimeSpent, lvl: selectedLevel, date: Date.now() };
            let lb = JSON.parse(localStorage.getItem('coludoku_lb_v3') || "[]");
            lb.push(record);
            lb.sort((a,b) => b.score - a.score || a.time - b.time);
            lb = lb.slice(0, 10);
            localStorage.setItem('coludoku_lb_v3', JSON.stringify(lb));
            return lb;
        }

        function updateLevelBest(level, time) {
            let bests = JSON.parse(localStorage.getItem('coludoku_best_v3') || "{}");
            if (!bests[level] || time < bests[level].time) {
                bests[level] = { name: playerName, time: time };
                localStorage.setItem('coludoku_best_v3', JSON.stringify(bests));
            }
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60).toString().padStart(2,'0');
            const s = (sec % 60).toString().padStart(2,'0');
            return `${m}:${s}`;
        }

        function showEndScreen() {
            document.getElementById('end-modal').style.display = 'flex';
            document.getElementById('end-player-name').innerText = `å°å°å¸«ï¼š${playerName} (æŒ‘æˆ° L${selectedLevel})`;
            
            // è¨ˆç®—ç†è«–æ»¿åˆ†
            let maxScore = 0;
            for(let i=1; i<=6; i++) maxScore += (ROUND_SETTINGS[i].base + ROUND_SETTINGS[i].bonus);

            document.getElementById('end-score').innerText = `${totalScore} / ${maxScore}`;
            document.getElementById('end-time').innerText = formatTime(totalTimeSpent);
            
            let msg = "";
            let pct = totalScore / maxScore;
            if (pct === 1) msg = "è¶…å‡¡å…¥è–ï¼Œå‚³å¥‡å°å°å¸«ï¼ğŸ†";
            else if (pct >= 0.9) msg = "å‡ºé¡æ‹”èƒï¼Œè‡³å°Šå°å°å¸«ï¼âœ¨";
            else if (pct >= 0.75) msg = "é¦–å±ˆä¸€æŒ‡ï¼Œé«˜ç´šå°å°å¸«ï¼";
            else if (pct >= 0.6) msg = "ä¸­è¦ä¸­çŸ©ï¼Œåˆç´šå°å°å¸«ï¼";
            else msg = "å†æ¥å†å‹µ...è¦‹ç¿’å°å°å¸«ï¼";
            document.getElementById('end-msg').innerText = msg;

            const lbData = saveRecord();
            const lbBody = document.getElementById('lb-body');
            lbBody.innerHTML = "";
            lbData.forEach((r, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="lb-rank">${i+1}</td><td class="lb-name">${r.name}<br><small style="color:#bdc3c7;">L${r.lvl}</small></td><td class="lb-score">${r.score}</td><td class="lb-time">${formatTime(r.time)}</td>`;
                lbBody.appendChild(tr);
            });

            const bests = JSON.parse(localStorage.getItem('coludoku_best_v3') || "{}");
            const blGrid = document.getElementById('best-levels-grid');
            blGrid.innerHTML = "";
            for (let i=0; i<=3; i++) {
                const rec = bests[i];
                const div = document.createElement('div');
                div.className = 'bl-item';
                if(rec) div.innerHTML = `<span class="bl-lvl">L${i}</span> ${rec.name} (${formatTime(rec.time)})`;
                else div.innerHTML = `<span class="bl-lvl">L${i}</span> è™›ä½ä»¥å¾…`;
                blGrid.appendChild(div);
            }
        }

        // --- éŠæˆ²æ“ä½œ ---
        function renderGameGrid() {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';
            const glowLayer = document.createElement('div');
            glowLayer.className = 'glow-overlay';
            glowLayer.id = 'glow-layer';
            container.appendChild(glowLayer);

            for(let i=0; i<9; i++) {
                const config = currentLayoutConfig[i];
                const block = userBoard[i];
                const div = document.createElement('div');
                if (config.type === 'EMPTY') {
                    div.className = 'block empty-slot';
                    div.style.visibility = 'hidden';
                } else {
                    div.className = 'block';
                    if (block) {
                        if (block.isFixed) div.classList.add('fixed'); else div.classList.add('user-placed');
                        const imagePath = `images/block_${block.id}_${block.face}.png`;
                        const rot = block.rot * 90;
                        div.innerHTML = `<img src="${imagePath}" class="block-image" style="transform: rotate(${rot}deg);" draggable="false">`;
                        const edgeZone = document.createElement('div');
                        edgeZone.className = 'zone-edge';
                        edgeZone.onclick = (e) => { e.stopPropagation(); rotateBlock(i); };
                        div.appendChild(edgeZone);
                        if (!block.isFixed) {
                            const centerZone = document.createElement('div');
                            centerZone.className = 'zone-center';
                            centerZone.onclick = (e) => { e.stopPropagation(); flipBlock(i); };
                            
                            const startLongPress = () => { longPressTimer = setTimeout(() => clearBlock(i), 600); };
                            const cancelLongPress = () => clearTimeout(longPressTimer);
                            centerZone.addEventListener('mousedown', startLongPress);
                            centerZone.addEventListener('touchstart', startLongPress);
                            centerZone.addEventListener('mouseup', cancelLongPress);
                            centerZone.addEventListener('touchend', cancelLongPress);
                            centerZone.addEventListener('mouseleave', cancelLongPress);

                            div.appendChild(centerZone);
                        }
                    } else {
                        div.innerHTML = '+';
                        div.className = 'empty-slot';
                        div.onclick = () => openPicker(i);
                    }
                }
                container.appendChild(div);
            }
            updateGlowsAndWin();
        }

        function rotateBlock(index) {
            if (userBoard[index] && !isRoundWon) {
                userBoard[index].rot = (userBoard[index].rot + 1) % 4;
                playSound('action'); renderGameGrid();
            }
        }
        function flipBlock(index) {
            if (userBoard[index] && !userBoard[index].isFixed && !isRoundWon) {
                userBoard[index].face = userBoard[index].face === 'B' ? 'W' : 'B';
                playSound('action'); renderGameGrid();
            }
        }
        function clearBlock(index) {
            if (isRoundWon) return;
            userBoard[index] = null;
            playSound('action'); 
            renderGameGrid();
        }
        
        function getAvailableBlocks() {
            const used = new Set();
            userBoard.forEach(b => { if(b) used.add(b.id); });
            return [1,2,3,4,5,6,7,8,9].filter(id => !used.has(id));
        }

        function openPicker(index) {
            if (isRoundWon) return;
            pickingSlot = index;
            pickerFace = 'B'; 
            renderPickerGrid();
            document.getElementById('picker-modal').style.display = 'flex';
        }

        function togglePickerFace() {
            pickerFace = (pickerFace === 'B') ? 'W' : 'B';
            renderPickerGrid();
        }

        function renderPickerGrid() {
            const available = getAvailableBlocks();
            const grid = document.getElementById('picker-grid');
            document.getElementById('picker-title').innerText = `é¸æ“‡é­”çŸ³ (${pickerFace}é¢)`;
            grid.innerHTML = '';
            
            available.forEach(id => {
                const div = document.createElement('div');
                div.className = 'picker-item';
                div.innerHTML = `<img src="images/block_${id}_${pickerFace}.png">`;
                div.onclick = () => {
                    userBoard[pickingSlot] = { id: id, face: pickerFace, rot: 0, isFixed: false };
                    playSound('action'); closePicker(); renderGameGrid();
                };
                grid.appendChild(div);
            });
        }

        function closePicker() { document.getElementById('picker-modal').style.display = 'none'; }

        // --- é©—è­‰èˆ‡å…‰æšˆ ---
        function getRotatedMatrix(matrix, times) {
            let m = JSON.parse(JSON.stringify(matrix));
            for (let t = 0; t < times; t++) {
                const newM = [[0,0],[0,0]];
                newM[0][1] = m[0][0]; newM[1][1] = m[0][1];
                newM[1][0] = m[1][1]; newM[0][0] = m[1][0];
                m = newM;
            } return m;
        }

        function getFullGrid() {
            let fullGrid = Array(6).fill().map(() => Array(6).fill(0));
            for(let i=0; i<9; i++) {
                if(!userBoard[i]) continue;
                let b = userBoard[i];
                let baseRow = Math.floor(i / 3) * 2;
                let baseCol = (i % 3) * 2;
                let matrix = getRotatedMatrix(BLOCKS[b.id][b.face], b.rot);
                fullGrid[baseRow][baseCol] = matrix[0][0]; fullGrid[baseRow][baseCol+1] = matrix[0][1];
                fullGrid[baseRow+1][baseCol] = matrix[1][0]; fullGrid[baseRow+1][baseCol+1] = matrix[1][1];
            } return fullGrid;
        }

        function isLineValid(grid, idx, isRow) {
            let values = [];
            for (let k = 0; k < 6; k++) {
                const val = isRow ? grid[idx][k] : grid[k][idx];
                if (val !== 0) values.push(val);
            }
            if (values.length === 0) return false;
            const unique = new Set(values);
            return unique.size === values.length;
        }

        function updateGlowsAndWin() {
            const glowLayer = document.getElementById('glow-layer');
            glowLayer.innerHTML = '';
            const grid = getFullGrid();
            let currentValidLineCount = 0;
            
            for (let r = 0; r < 3; r++) {
                let cnt = 0;
                if(userBoard[r*3]) cnt++; if(userBoard[r*3+1]) cnt++; if(userBoard[r*3+2]) cnt++;
                if (cnt > 1 && isLineValid(grid, r*2, true) && isLineValid(grid, r*2+1, true)) {
                    const glow = document.createElement('div');
                    glow.className = 'glow-bar glow-row';
                    glow.style.top = (r * 33.33 + 0.5) + '%';
                    glowLayer.appendChild(glow);
                    currentValidLineCount++;
                }
            }
            for (let c = 0; c < 3; c++) {
                let cnt = 0;
                if(userBoard[c]) cnt++; if(userBoard[c+3]) cnt++; if(userBoard[c+6]) cnt++;
                if (cnt > 1 && isLineValid(grid, c*2, false) && isLineValid(grid, c*2+1, false)) {
                    const glow = document.createElement('div');
                    glow.className = 'glow-bar glow-col';
                    glow.style.left = (c * 33.33 + 0.5) + '%';
                    glowLayer.appendChild(glow);
                    currentValidLineCount++;
                }
            }
            if (currentValidLineCount > lastValidLineCount) playSound('line');
            lastValidLineCount = currentValidLineCount;

            const isFull = userBoard.every((b, i) => currentLayoutConfig[i].type === 'EMPTY' || b !== null);
            if (isFull && isValid(userBoard) && !isRoundWon) {
                isRoundWon = true;
                clearInterval(timerInterval);
                playSound('win');
                const spent = Math.floor((Date.now() - roundStartTime) / 1000);
                
                // é€Ÿé€šåˆ¤å®šï¼šé€šé—œæ™‚é–“ <= 60ç§’
                if (spent <= 60) {
                    setTimeout(() => playSound('bonus'), 800);
                    const bonusPt = ROUND_SETTINGS[currentRound].bonus;
                    document.getElementById('level-info').innerText += ` â­ é€Ÿé€šé”æˆ (+${bonusPt}åˆ†)`;
                    document.getElementById('level-info').style.color = "#f1c40f";
                }
                document.getElementById('grid-container').classList.add('win-glow');
                document.getElementById('btn-next').style.display = 'inline-block';
                document.getElementById('action-controls').style.display = 'none'; 
            }
        }

        function isValid(boardState) {
            let fullGrid = Array(6).fill().map(() => Array(6).fill(0));
            for(let i=0; i<9; i++) {
                if(!boardState[i]) continue;
                let b = boardState[i];
                let baseRow = Math.floor(i / 3) * 2;
                let baseCol = (i % 3) * 2;
                let matrix = getRotatedMatrix(BLOCKS[b.id][b.face], b.rot);
                fullGrid[baseRow][baseCol] = matrix[0][0]; fullGrid[baseRow][baseCol+1] = matrix[0][1];
                fullGrid[baseRow+1][baseCol] = matrix[1][0]; fullGrid[baseRow+1][baseCol+1] = matrix[1][1];
            }
            for (let i = 0; i < 6; i++) {
                let rowSeen = new Set(), colSeen = new Set();
                for (let j = 0; j < 6; j++) {
                    let rVal = fullGrid[i][j];
                    if (rVal !== 0) { if (rowSeen.has(rVal)) return false; rowSeen.add(rVal); }
                    let cVal = fullGrid[j][i];
                    if (cVal !== 0) { if (colSeen.has(cVal)) return false; colSeen.add(cVal); }
                }
            }
            return true;
        }

        // --- æ±‚è§£èˆ‡è¼”åŠ© ---
        function forceSolve(manual = true) {
            clearInterval(timerInterval);
            let solverBoard = Array(9).fill(null);
            let usedIDs = new Set();
            for(let i=0; i<9; i++) {
                if (currentLayoutConfig[i].type === 'FIXED') usedIDs.add(currentLayoutConfig[i].id);
            }
            setTimeout(() => {
                if (solveStep(0, solverBoard, usedIDs)) {
                    userBoard = solverBoard;
                    renderGameGrid();
                    document.getElementById('grid-container').classList.add('win-glow');
                    document.getElementById('btn-solve').disabled = true;
                    document.getElementById('btn-reset').disabled = true; 
                    document.getElementById('btn-next').style.display = 'inline-block';
                    document.getElementById('action-controls').style.display = 'none';
                    isRoundWon = true; 
                    isSolverUsed = true;
                    if (manual) {
                        document.getElementById('level-info').innerText = "ä½¿ç”¨ç¦å¿Œé­”æ³•ï¼Œæœ¬é—œä¸è¨ˆåˆ†";
                        document.getElementById('level-info').style.color = "#e74c3c";
                    }
                } else { alert("ç„¡æ³•å°å°ï¼"); }
            }, 100);
        }

        function solveStep(idx, board, usedIDs, dryRun = false) {
            if (idx >= 9) return true;
            const config = currentLayoutConfig[idx];
            if (config.type === 'EMPTY') return solveStep(idx + 1, board, usedIDs, dryRun);
            if (config.type === 'FIXED') {
                const { id, face } = config;
                for (let rot = 0; rot < 4; rot++) {
                    board[idx] = { id, face, rot, isFixed: true };
                    if (isValidPartially(board)) {
                        if (solveStep(idx + 1, board, usedIDs, dryRun)) return true;
                    }
                }
                board[idx] = null; return false;
            }
            if (config.type === 'SOLVE') {
                for (let id = 1; id <= 9; id++) {
                    if (!usedIDs.has(id)) {
                        usedIDs.add(id);
                        for (let face of ['B', 'W']) {
                            for (let rot = 0; rot < 4; rot++) {
                                board[idx] = { id, face, rot, isFixed: false };
                                if (isValidPartially(board)) {
                                    if (solveStep(idx + 1, board, usedIDs, dryRun)) return true;
                                }
                            }
                        }
                        board[idx] = null; usedIDs.delete(id);
                    }
                }
                return false;
            }
            return false;
        }

        function isValidPartially(boardState) {
             let fullGrid = Array(6).fill().map(() => Array(6).fill(0));
             for(let i=0; i<9; i++) {
                if(!boardState[i]) continue;
                let b = boardState[i];
                let baseRow = Math.floor(i / 3) * 2;
                let baseCol = (i % 3) * 2;
                let matrix = getRotatedMatrix(BLOCKS[b.id][b.face], b.rot);
                fullGrid[baseRow][baseCol] = matrix[0][0]; fullGrid[baseRow][baseCol+1] = matrix[0][1];
                fullGrid[baseRow+1][baseCol] = matrix[1][0]; fullGrid[baseRow+1][baseCol+1] = matrix[1][1];
            }
            for (let i = 0; i < 6; i++) {
                let rowSeen = new Set(), colSeen = new Set();
                for (let j = 0; j < 6; j++) {
                    let rVal = fullGrid[i][j];
                    if (rVal !== 0) { if (rowSeen.has(rVal)) return false; rowSeen.add(rVal); }
                    let cVal = fullGrid[j][i];
                    if (cVal !== 0) { if (colSeen.has(cVal)) return false; colSeen.add(cVal); }
                }
            }
            return true;
        }
    </script>
</body>
</html>